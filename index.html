<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Ark Astrogem Calculator</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        body { 
            background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; 
            margin: 0; padding: 15px; 
            background-image: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%);
            background-attachment: fixed;
            overflow-x: hidden;
        }
        
        h1 { 
            text-align: center; font-size: 2.2rem; font-weight: 800; margin-top: 5px; margin-bottom: 5px; 
            background: linear-gradient(to right, #38bdf8, #818cf8, #c084fc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
        }
        
        #status-msg { text-align:center; color: #fbbf24; font-weight: 600; font-size: 13px; margin-bottom: 15px; letter-spacing: 0.5px;}
        
        .container { max-width: 1450px; margin: 0 auto; display: grid; grid-template-columns: 260px 480px 1fr; gap: 15px; align-items: start; }
        @media (max-width: 1150px) { .container { grid-template-columns: 1fr; } }

        .panel { 
            background-color: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; 
            box-shadow: 0 8px 20px -5px rgba(0,0,0,0.3); position: relative; overflow: hidden;
            max-height: 85vh; overflow-y: auto;
        }
        .panel::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .panel:nth-child(1)::before { background: linear-gradient(to right, #f59e0b, #ef4444); } 
        .panel:nth-child(2)::before { background: linear-gradient(to right, #3b82f6, #8b5cf6); } 
        .panel:nth-child(3)::before { background: linear-gradient(to right, #10b981, #3b82f6); } 
        
        h2 { color: #f1f5f9; margin-top: 0; font-size: 1.1rem; }
        
        .inv-tabs { display: flex; gap: 6px; margin-bottom: 12px; background: rgba(15, 23, 42, 0.6); padding: 6px; border-radius: 8px; border: 1px solid #334155; }
        .inv-tab-btn { flex: 1; padding: 8px; border: none; background: transparent; color: #94a3b8; font-weight: 800; font-size: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s; margin: 0; letter-spacing: 1px;}
        .inv-tab-btn.active { background: linear-gradient(135deg, #38bdf8, #818cf8); color: white; box-shadow: 0 4px 10px rgba(56, 189, 248, 0.2); }
        .inv-tab-btn:hover:not(.active) { background: #334155; color: white; }

        #gem-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .w-row { display: flex; flex-wrap: wrap; gap: 6px; background: rgba(15, 23, 42, 0.4); padding: 10px 8px; border-radius: 10px; border: 1px solid #1e293b; align-content: flex-start;}
        .w-label { width: 100%; font-size: 12px; font-weight: 800; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px dashed #334155; padding-bottom: 5px; text-align: center;}
        
        .gem-box { display: flex; flex-direction: column; align-items: center; background: #0f172a; padding: 6px 4px; border-radius: 8px; border: 1px solid #334155; width: calc(25% - 4.5px); box-sizing: border-box; transition: all 0.2s ease; }
        .gem-box:hover { border-color: #38bdf8; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateY(-2px); }
        .gem-icon { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; font-size: 11px; margin: 0 0 5px 0; cursor: pointer; box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .gem-icon:active { transform: scale(0.9) translateY(2px); }
        .gem-pts { font-size: 10px; color: #cbd5e1; margin-bottom: 4px; font-weight: 700; }
        
        .gem-box input[type="number"] { width: 100%; padding: 4px 0; font-size: 13px; background: #1e293b; border-radius: 6px; box-sizing: border-box; text-align: center; border: 1px solid transparent; color: white;}
        .gem-box input[type="number"]:focus { outline: none; border-color: #38bdf8; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        
        select { width: 100%; padding: 8px; border-radius: 6px; font-weight: 600; font-size: 13px; font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; border: 1px solid #334155; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        select:focus { outline: none; border-color: #38bdf8; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }
        label { font-weight: 600; color: #94a3b8; display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;}
        
        button { width: 100%; padding: 10px; margin-top: 8px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.2s; font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-calc { background: linear-gradient(135deg, #10b981, #059669); color: white; font-size: 14px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); margin-top: 25px;} 
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); background: linear-gradient(135deg, #34d399, #10b981); }
        .btn-reset { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; } 
        .btn-reset:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3); }
        .btn-delete { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; } 
        .btn-delete:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(239, 68, 68, 0.3); }
        .btn-hard-reset { background-color: transparent; color: #64748b; border: 1px dashed #475569; margin-top: 20px; font-size: 10px; padding: 8px; box-shadow: none; } 
        .btn-hard-reset:hover { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        
        .tabs { display: flex; margin-bottom: 20px; background-color: transparent; padding: 0; overflow-x: auto; gap: 8px; align-items: center; justify-content: center; }
        .tab-btn { background-color: #1e293b; color: #94a3b8; padding: 8px 16px; border: 1px solid #334155; border-radius: 20px; font-weight: 600; font-size: 12px; width: auto; margin: 0; text-transform: none; letter-spacing: normal; }
        .tab-btn:hover { background-color: #334155; color: white; }
        .tab-btn.active { background: linear-gradient(135deg, #38bdf8, #3b82f6); color: white; border: none; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); }
        .add-tab-btn { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px dashed #10b981; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        #result-area { 
            background-color: #0f172a; color: #e2e8f0; padding: 20px; border-radius: 10px; 
            font-family: 'Inter', sans-serif; white-space: pre-wrap; 
            min-height: 200px; max-height: 700px; overflow-y: auto; font-size: 14px; 
            border: 1px solid #334155; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2); 
            line-height: 1.6;
        }

        #debug-console { margin-top: 15px; background: #000; color: #ef4444; font-family: monospace; padding: 10px; border-radius: 8px; border: 1px solid #ef4444; font-size: 11px; display: none; }
        
        #joke-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        #joke-gif { max-width: 80%; max-height: 60vh; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 2px solid #38bdf8; }
        #joke-text { color: white; font-size: 32px; margin-top: 30px; text-align: center; text-shadow: 0 4px 10px rgba(0,0,0,0.5); font-weight: 800; padding: 0 20px; letter-spacing: 1px; }
        #joke-close { width: 200px; margin-top: 40px; padding: 15px; font-size: 16px; background: #ef4444; }

        #btn-lang {
            position: fixed; left: 20px; top: 20px; width: auto; margin: 0;
            background: #1e293b; color: #94a3b8; border: 1px solid #334155; 
            border-radius: 6px; padding: 6px 12px; font-weight: 700; 
            cursor: pointer; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            transition: 0.2s; z-index: 1000; text-transform: none; letter-spacing: normal;
        }
        #btn-lang:hover { background: #334155; border-color: #38bdf8; color: white; }

        .core-row { margin-bottom: 15px; }
        .auto-label { font-size: 12px; color: #38bdf8; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 700; }
        .auto-label input { cursor: pointer; }
        .core-flex { display: flex; gap: 8px; align-items: center; }
        .target-box { flex: 1; align-items: center; gap: 6px; }
        .target-select { color: #38bdf8; border-color: #38bdf8; }
    </style>
</head>
<body>

<div id="joke-overlay">
        <audio id="audio-chaewon" src="chaewon.mp3"></audio>
        <audio id="audio-gay" src="gay.mp3"></audio>
        <img id="joke-gif" src="" alt="S√ºrpriz">
        <div id="joke-text"></div>
        <button id="joke-close" onclick="
            document.getElementById('joke-overlay').style.display='none';
            document.getElementById('audio-chaewon').pause();
            document.getElementById('audio-chaewon').currentTime = 0;
            document.getElementById('audio-gay').pause();
            document.getElementById('audio-gay').currentTime = 0;
        ">CLOSE</button>
</div>
    
    <button id="btn-lang">üåê TR</button>

    <div style="max-width: 1450px; margin: 0 auto; position: relative;">
        <h1>Lost Ark Astrogem</h1>
        <div id="status-msg">System Loading...</div>
    </div>

    <div class="tabs" id="tab-container"></div>

    <div class="container">
        <div class="panel">
            
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 8px; margin-bottom: 15px;">
                <h2 id="title-core" style="margin: 0; border: none; padding: 0;">Core Settings</h2>
                <label class="auto-label">
                    <input type="checkbox" id="auto_master" checked> <span id="lbl-auto-master">Auto</span>
                </label>
            </div>
            
            <div class="core-row">
                <label style="margin-bottom: 6px;">Sun Core:</label>
                <div class="core-flex">
                    <select id="core1" style="flex: 1; margin:0;">
                        <option value="12">Legendary (12 WP)</option>
                        <option value="15" selected>Relic (15 WP)</option>
                        <option value="17">Ancient (17 WP)</option>
                    </select>
                    <div id="box-target1" class="target-box" style="display: none;">
                        <span style="font-size: 11px; font-weight: 600; color: #38bdf8;" id="lbl-tgt1">Target:</span>
                        <select id="target1" class="target-select" style="flex: 1; margin:0;">
                            <option value="0">0</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                            <option value="13">13</option><option value="14">14</option><option value="15">15</option>
                            <option value="16">16</option><option value="17" selected>17</option><option value="18">18</option>
                            <option value="19">19</option><option value="20">20</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="core-row">
                <label style="margin-bottom: 6px;">Moon Core:</label>
                <div class="core-flex">
                    <select id="core2" style="flex: 1; margin:0;">
                        <option value="12">Legendary (12 WP)</option>
                        <option value="15" selected>Relic (15 WP)</option>
                        <option value="17">Ancient (17 WP)</option>
                    </select>
                    <div id="box-target2" class="target-box" style="display: none;">
                        <span style="font-size: 11px; font-weight: 600; color: #38bdf8;" id="lbl-tgt2">Target:</span>
                        <select id="target2" class="target-select" style="flex: 1; margin:0;">
                            <option value="0">0</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                            <option value="13">13</option><option value="14">14</option><option value="15">15</option>
                            <option value="16">16</option><option value="17" selected>17</option><option value="18">18</option>
                            <option value="19">19</option><option value="20">20</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="core-row">
                <label style="margin-bottom: 6px;">Star Core:</label>
                <div class="core-flex">
                    <select id="core3" style="flex: 1; margin:0;">
                        <option value="12">Legendary (12 WP)</option>
                        <option value="15" selected>Relic (15 WP)</option>
                        <option value="17">Ancient (17 WP)</option>
                    </select>
                    <div id="box-target3" class="target-box" style="display: none;">
                        <span style="font-size: 11px; font-weight: 600; color: #38bdf8;" id="lbl-tgt3">Target:</span>
                        <select id="target3" class="target-select" style="flex: 1; margin:0;">
                            <option value="0">0</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                            <option value="13">13</option><option value="14">14</option><option value="15">15</option>
                            <option value="16">16</option><option value="17" selected>17</option><option value="18">18</option>
                            <option value="19">19</option><option value="20">20</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="btn-calculate" class="btn-calc">CALCULATE & SAVE</button>
            
            <div style="display: flex; gap: 8px;">
                <button id="btn-reset" class="btn-reset">‚Ü∫ RESET</button>
                <button id="btn-delete-char" class="btn-delete">üóëÔ∏è DEL CHAR</button>
            </div>

            <button id="btn-hard-reset" class="btn-hard-reset">‚ö† FACTORY RESET</button>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #334155; padding-bottom:8px;">
                <h2 id="title-inv" style="margin:0; border:none; padding:0;">Inventory</h2>
            </div>
            <div class="inv-tabs">
                <button id="btn-inv-order" class="inv-tab-btn active">ORDER</button>
                <button id="btn-inv-chaos" class="inv-tab-btn">CHAOS</button>
            </div>
            <div id="gem-inputs"></div>
        </div>

        <div class="panel">
            <h2 id="title-res">Analysis Results</h2>
            <div id="result-area" style="color: #94a3b8; font-style: italic; text-align: center;">Results will appear here.</div>
        </div>
    </div>

    <div id="debug-console">Console: Clean</div>

<py-script>
from js import document, window, localStorage
from itertools import combinations_with_replacement
from collections import Counter
import json
from pyodide.ffi import create_proxy
import traceback

LT = chr(60)
GT = chr(62)

def log_error(e):
    try:
        err_div = document.getElementById("debug-console")
        if err_div:
            err_div.style.display = "block"
            err_div.innerText = "ERROR:\n" + str(e) + "\n" + str(traceback.format_exc())
    except: pass

LANG = {
    "tr": {
        "core_settings": "Core Ayarlarƒ±",
        "inventory": "Envanter",
        "results": "Analiz Sonu√ßlarƒ±",
        "calc_btn": "HESAPLA & KAYDET",
        "reset_btn": "‚Ü∫ SIFIRLA",
        "del_btn": "üóëÔ∏è √áARI Sƒ∞L",
        "hard_reset_btn": "‚ö† FABRƒ∞KA AYARLARI",
        "add_tab": "‚ûï Ekle",
        "prompt_new": "Yeni karakterin adƒ±nƒ± girin:",
        "alert_exists": "Bu isimde bir karakter zaten var!",
        "created": "olu≈üturuldu",
        "confirm_del": "isimli karakteri silmek istediƒüinize emin misiniz?",
        "deleted": "Karakter silindi.",
        "loaded": "Y√ºklendi",
        "prompt_rename": "Karakter adƒ±nƒ± deƒüi≈ütir",
        "calc_wait": "Hesaplanƒ±yor... L√ºtfen bekleyin.",
        "inv_empty": "Envanter bo≈ü. L√ºtfen ta≈ü ekleyin.",
        "results_title": "SONU√áLARI",
        "total_pts": "TOPLAM PUAN",
        "success": "‚úÖ BA≈ûARILI",
        "fail": "‚ùå BA≈ûARISIZ",
        "sub_target": "Ara Hedef",
        "equip": "Takƒ±lacaklar",
        "empty": "BO≈û",
        "suggestion": "HEDEF √ñNERƒ∞Sƒ∞",
        "need_find": "Bulunmasƒ± Gereken",
        "in_inv": "Envanterde var",
        "new_layout": "Yeni Dizilim",
        "reset_msg": "Sayƒ±lar Sƒ±fƒ±rlandƒ±.",
        "hard_reset_warn": "Dƒ∞KKAT: T√ºm karakterler ve veriler silinecek. Emin misiniz?",
        "sys_ready": "Sistem Hazƒ±r! üéâ",
        "click_add": "Tƒ±kla ve 1 Ekle",
        "auto_target": "Auto",
        "lbl_target": "Hedef:"
    },
    "en": {
        "core_settings": "Core Settings",
        "inventory": "Inventory",
        "results": "Analysis Results",
        "calc_btn": "CALCULATE & SAVE",
        "reset_btn": "‚Ü∫ RESET",
        "del_btn": "üóëÔ∏è DEL CHAR",
        "hard_reset_btn": "‚ö† FACTORY RESET",
        "add_tab": "‚ûï Add",
        "prompt_new": "Enter new character name:",
        "alert_exists": "A character with this name already exists!",
        "created": "created",
        "confirm_del": "- Are you sure you want to delete this character?",
        "deleted": "Character deleted.",
        "loaded": "Loaded",
        "prompt_rename": "Rename character",
        "calc_wait": "Calculating... Please wait.",
        "inv_empty": "Inventory is empty. Please add gems.",
        "results_title": "RESULTS",
        "total_pts": "TOTAL SCORE",
        "success": "‚úÖ SUCCESS",
        "fail": "‚ùå FAILED",
        "sub_target": "Sub-Target",
        "equip": "Equip",
        "empty": "EMPTY",
        "suggestion": "SUGGESTION",
        "need_find": "Need to Find",
        "in_inv": "In inventory",
        "new_layout": "New Layout",
        "reset_msg": "Numbers Reset.",
        "hard_reset_warn": "WARNING: All characters and data will be deleted. Are you sure?",
        "sys_ready": "System Ready! üéâ",
        "click_add": "Click to add 1",
        "auto_target": "Auto",
        "lbl_target": "Target:"
    }
}

current_lang = "en"

def T(key):
    return LANG.get(current_lang, LANG["en"]).get(key, key)

def safe_msg(text, color="#e2e8f0"):
    res_div = document.getElementById("result-area")
    if res_div:
        res_div.innerText = text
        res_div.style.color = color
        res_div.style.textAlign = "center"

GEM_STATS = {
    "S": {"will": 3, "pts": 5, "color": "#ef4444"},
    "A": {"will": 3, "pts": 4, "color": "#f97316"},
    "B": {"will": 3, "pts": 3, "color": "#f59e0b"},
    "C": {"will": 3, "pts": 2, "color": "#b45309"}, 
    "D": {"will": 4, "pts": 5, "color": "#10b981"},
    "E": {"will": 4, "pts": 4, "color": "#059669"},
    "F": {"will": 4, "pts": 3, "color": "#047857"},
    "G": {"will": 4, "pts": 2, "color": "#064e3b"}, 
    "H": {"will": 5, "pts": 5, "color": "#3b82f6"},
    "I": {"will": 5, "pts": 4, "color": "#2563eb"},
    "J": {"will": 5, "pts": 3, "color": "#8b5cf6"},
    "K": {"will": 5, "pts": 2, "color": "#6d28d9"}, 
    "L": {"will": 6, "pts": 5, "color": "#cbd5e1"},
    "M": {"will": 6, "pts": 4, "color": "#94a3b8"}, 
    "N": {"will": 6, "pts": 3, "color": "#64748b"}, 
    "O": {"will": 6, "pts": 2, "color": "#475569"}, 
    "P": {"will": 7, "pts": 5, "color": "#334155"}, 
    "R": {"will": 7, "pts": 4, "color": "#1e293b"}, 
    "T": {"will": 7, "pts": 3, "color": "#0f172a"}, 
    "U": {"will": 7, "pts": 2, "color": "#020617"}, 
    "V": {"will": 8, "pts": 5, "color": "#ec4899"}, 
    "W": {"will": 8, "pts": 4, "color": "#db2777"}, 
    "X": {"will": 8, "pts": 3, "color": "#be185d"}, 
    "Y": {"will": 8, "pts": 2, "color": "#9d174d"}, 
} 

TARGET_SCORES = {12: 14, 15: 17, 17: 17}
SECONDARY_SCORES = {12: 10, 15: 14, 17: 14}
TERTIARY_SCORES = {12: 10, 15: 10, 17: 10}

current_char = ""
current_inv_tab = "order" 
app_data = {}
ui_proxies = []

def check_for_joke(name):
    try:
        overlay = document.getElementById("joke-overlay")
        gif = document.getElementById("joke-gif")
        text = document.getElementById("joke-text")
        
        if not overlay or not gif or not text: return

        if name == "Boisy":
            text.innerText = "NASI Sƒ∞TE YAPMI≈ûIM AMA √áOK ƒ∞Yƒ∞ Dƒ∞ Mƒ∞"
            gif.src = "chaewon.gif"
            overlay.style.display = "flex"
            document.getElementById("audio-chaewon").play()
        elif name == "Aelathea":
            text.innerText = "GAY"
            gif.src = "chuu.gif"
            overlay.style.display = "flex"
            document.getElementById("audio-gay").play()
        elif name == "Abd√ºllrezzak":
            text.innerText = "REAPER 1760TAN SONRA A√áILIYOMU≈û"
            gif.src = "reaper.gif"
            overlay.style.display = "flex"
        elif name == "Scarleon":
            text.innerText = "ESO WARDANCER GAAAAAAANG"
            gif.src = "backattack.gif"
            overlay.style.display = "flex"
        elif name == "Tarawah":
            text.innerText = "BEN Mƒ∞ DEDƒ∞M REAPER OYNA Dƒ∞YE"
            gif.src = "backattack.gif"
            overlay.style.display = "flex"
    except Exception as e: log_error(e)

def apply_language():
    try:
        document.getElementById("title-core").innerText = T("core_settings")
        document.getElementById("title-inv").innerText = T("inventory")
        document.getElementById("title-res").innerText = T("results")
        document.getElementById("btn-calculate").innerText = T("calc_btn")
        document.getElementById("btn-reset").innerText = T("reset_btn")
        document.getElementById("btn-delete-char").innerText = T("del_btn")
        document.getElementById("btn-hard-reset").innerText = T("hard_reset_btn")
        
        lbl_auto_master = document.getElementById("lbl-auto-master")
        if lbl_auto_master: lbl_auto_master.innerText = T("auto_target")
        
        for i in range(1,4):
            lbl_tgt = document.getElementById(f"lbl-tgt{i}")
            if lbl_tgt: lbl_tgt.innerText = T("lbl_target")

        lang_btn = document.getElementById("btn-lang")
        if lang_btn:
            lang_btn.innerText = "üåê TR" if current_lang == "en" else "üåê EN"
            
        status_el = document.getElementById("status-msg")
        if status_el and ("Hazƒ±r" in status_el.innerText or "Ready" in status_el.innerText):
            status_el.innerText = T("sys_ready")
            
        for code in GEM_STATS.keys():
            icon = document.getElementById("icon_" + code)
            if icon: icon.title = T("click_add")
            
        render_tabs() 
        
        res_div = document.getElementById("result-area")
        if res_div and "===" not in res_div.innerText:
            res_div.innerText = ""
    except Exception as e: log_error(e)

def toggle_lang(event):
    global current_lang
    try:
        current_lang = "tr" if current_lang == "en" else "en"
        localStorage.setItem("astrogem_lang", current_lang)
        apply_language()
    except Exception as e: log_error(e)

def add_character(event=None):
    try:
        new_name = window.prompt(T("prompt_new"))
        if new_name and new_name.strip():
            new_name = new_name.strip()
            if new_name in app_data:
                window.alert(T("alert_exists"))
                return
            check_for_joke(new_name)
            app_data[new_name] = {"inventory_order": {}, "inventory_chaos": {}, "cores": [0,0,0], "targets": [{"auto":True, "val":17},{"auto":True, "val":17},{"auto":True, "val":17}]}
            global current_char
            current_char = new_name
            save_data()
            render_tabs()
            load_ui_for_char(current_char)
            safe_msg("--- '" + current_char + "' " + T("created") + " ---", "#10b981")
    except Exception as e: log_error(e)

def delete_character(event=None):
    global current_char
    try:
        msg = f"'{current_char}' {T('confirm_del')}" if current_lang == "tr" else f"{T('confirm_del')} '{current_char}'?"
        if window.confirm(msg):
            del app_data[current_char]
            if not app_data:
                app_data["Character 1"] = {"inventory_order": {}, "inventory_chaos": {}, "cores": [0,0,0], "targets": [{"auto":True, "val":17},{"auto":True, "val":17},{"auto":True, "val":17}]}
            current_char = list(app_data.keys())[0]
            save_data()
            render_tabs()
            load_ui_for_char(current_char)
            safe_msg(T("deleted") + "\n--- " + current_char + " " + T("loaded") + " ---", "#ef4444")
    except Exception as e: log_error(e)

def switch_tab_event(event):
    name = event.currentTarget.getAttribute("data-name")
    switch_tab(name)

def rename_tab_event(event):
    name = event.currentTarget.getAttribute("data-name")
    rename_tab(name)

def render_tabs():
    global ui_proxies
    try:
        container = document.getElementById("tab-container")
        if not container: return
        container.innerHTML = ""
        for name in app_data.keys():
            btn = document.createElement("button")
            btn.innerText = name
            btn.className = "tab-btn active" if name == current_char else "tab-btn"
            btn.setAttribute("data-name", name)
            
            c_proxy = create_proxy(switch_tab_event)
            d_proxy = create_proxy(rename_tab_event)
            ui_proxies.extend([c_proxy, d_proxy])
            
            btn.addEventListener("click", c_proxy)
            btn.addEventListener("dblclick", d_proxy)
            container.appendChild(btn)
            
        add_btn = document.createElement("button")
        add_btn.innerText = T("add_tab")
        add_btn.className = "tab-btn add-tab-btn"
        a_proxy = create_proxy(add_character)
        ui_proxies.append(a_proxy)
        add_btn.addEventListener("click", a_proxy)
        container.appendChild(add_btn)
    except Exception as e: log_error(e)

def switch_tab(new_name):
    global current_char
    try:
        save_data()
        current_char = new_name
        render_tabs()
        load_ui_for_char(current_char)
        safe_msg("--- " + current_char + " " + T("loaded") + " ---", "#38bdf8")
    except Exception as e: log_error(e)

def rename_tab(old_name):
    try:
        new_name = window.prompt(T("prompt_rename") + " (" + old_name + "):", old_name)
        if new_name and new_name.strip() and new_name != old_name:
            check_for_joke(new_name)
            data = app_data.pop(old_name)
            app_data[new_name] = data
            global current_char
            if current_char == old_name: current_char = new_name
            save_data()
            render_tabs()
    except Exception as e: log_error(e)

def switch_inv_tab(tab):
    global current_inv_tab
    try:
        save_data() 
        current_inv_tab = tab
        
        btn_o = document.getElementById("btn-inv-order")
        btn_c = document.getElementById("btn-inv-chaos")
        if btn_o and btn_c:
            if tab == "order":
                btn_o.classList.add("active")
                btn_c.classList.remove("active")
            else:
                btn_c.classList.add("active")
                btn_o.classList.remove("active")
                
        load_ui_for_char(current_char) 
    except Exception as e: log_error(e)

def load_ui_for_char(name):
    try:
        data = app_data.get(name, {"inventory_order": {}, "inventory_chaos": {}, "cores": [0,0,0], "targets": []})
        
        if "inventory" in data:
            data["inventory_order"] = data.pop("inventory")
        if "inventory_chaos" not in data:
            data["inventory_chaos"] = {}
        if "inventory_order" not in data:
            data["inventory_order"] = {}
            
        if current_inv_tab == "order":
            inv = data.get("inventory_order", {})
        else:
            inv = data.get("inventory_chaos", {})
            
        cores = data.get("cores", [0,0,0])
        targets = data.get("targets", [{"auto":True, "val":17},{"auto":True, "val":17},{"auto":True, "val":17}])
        if not targets or len(targets) < 3:
            targets = [{"auto":True, "val":17},{"auto":True, "val":17},{"auto":True, "val":17}]
            
        master_auto = targets[0]["auto"]
        
        for code in GEM_STATS:
            el = document.getElementById("gem_" + code)
            if el: el.value = str(inv.get(code, 0))
        
        master_el = document.getElementById("auto_master")
        if master_el: master_el.checked = master_auto
        
        for i in range(1, 4):
            c_el = document.getElementById(f"core{i}")
            if c_el: c_el.selectedIndex = cores[i-1]
            
            t_el = document.getElementById(f"target{i}")
            box = document.getElementById(f"box-target{i}")
            
            if t_el and box:
                t_el.value = str(targets[i-1]["val"])
                box.style.display = "none" if master_auto else "flex"
                    
    except Exception as e: log_error(e)

def get_ui_data():
    inv = {}
    try:
        for code in GEM_STATS:
            el = document.getElementById("gem_" + code)
            if el:
                val = el.value
                inv[code] = int(val) if val else 0
                
        master_el = document.getElementById("auto_master")
        is_auto = master_el.checked if master_el else True
        
        targets = []
        for i in range(1, 4):
            t_el = document.getElementById(f"target{i}")
            if t_el:
                targets.append({"auto": is_auto, "val": int(t_el.value)})
            else:
                targets.append({"auto": True, "val": 17})
                
        return {"inventory": inv, "cores": [
            document.getElementById("core1").selectedIndex,
            document.getElementById("core2").selectedIndex,
            document.getElementById("core3").selectedIndex
        ], "targets": targets}
    except Exception as e: 
        log_error(e)
        return {"inventory": {}, "cores": [0,0,0], "targets": [{"auto":True, "val":17},{"auto":True, "val":17},{"auto":True, "val":17}]}

def save_data():
    global app_data
    try:
        if current_char not in app_data: return
        data = get_ui_data()
        
        if current_inv_tab == "order":
            app_data[current_char]["inventory_order"] = data["inventory"]
        else:
            app_data[current_char]["inventory_chaos"] = data["inventory"]
            
        app_data[current_char]["cores"] = data["cores"]
        app_data[current_char]["targets"] = data["targets"]
        
        localStorage.setItem("astrogem_data", json.dumps(app_data))
    except Exception as e: log_error(e)

def load_data():
    global app_data, current_char, current_lang
    try:
        saved_lang = localStorage.getItem("astrogem_lang")
        if saved_lang in ["tr", "en"]: current_lang = saved_lang
        else: current_lang = "en" 
        
        stored = localStorage.getItem("astrogem_data")
        if stored: 
            app_data = json.loads(stored)
            if not app_data: app_data = {"Character 1": {"inventory_order": {}, "inventory_chaos": {}, "cores": [0,0,0], "targets": []}}
        else: 
            app_data = {"Character 1": {"inventory_order": {}, "inventory_chaos": {}, "cores": [0,0,0], "targets": []}}
        current_char = list(app_data.keys())[0]
        
        apply_language() 
        load_ui_for_char(current_char)
    except Exception as e: log_error(e)

def get_valid_combos(cap, inventory, available_types, t1, t2, t3):
    all_combos = [{"pts": 0, "will": 0, "gems": [], "counts": {}}]
    try:
        for r in range(1, 5):
            for combo_tuple in combinations_with_replacement(available_types, r):
                w = sum(GEM_STATS[g]["will"] for g in combo_tuple)
                if w > cap: continue
                counts = Counter(combo_tuple)
                if all(inventory.get(g, 0) >= c for g, c in counts.items()):
                    p = sum(GEM_STATS[g]["pts"] for g in combo_tuple)
                    all_combos.append({"pts": p, "will": w, "gems": list(combo_tuple), "counts": dict(counts)})

        primary_combos = []
        secondary_combos = []
        tertiary_combos = []
        fail_combos = []
        
        for c in all_combos:
            p = c['pts']
            if p >= t1: primary_combos.append(c)
            elif p >= t2: secondary_combos.append(c)
            elif p >= t3: tertiary_combos.append(c)
            else: fail_combos.append(c)

        primary_greedy = sorted(primary_combos, key=lambda x: (-x["pts"], len(x["gems"]))) 
        primary_humble = sorted(primary_combos, key=lambda x: (x["pts"], len(x["gems"])))  
        secondary_greedy = sorted(secondary_combos, key=lambda x: (-x["pts"], len(x["gems"])))
        secondary_cheap = sorted(secondary_combos, key=lambda x: (len(x["gems"]), x["pts"])) 
        tertiary_greedy = sorted(tertiary_combos, key=lambda x: (-x["pts"], len(x["gems"])))
        tertiary_cheap = sorted(tertiary_combos, key=lambda x: (len(x["gems"]), x["pts"])) 
        fail_greedy = sorted(fail_combos, key=lambda x: (-x["pts"], len(x["gems"])))
        fail_cheap = sorted(fail_combos, key=lambda x: (len(x["gems"]), x["pts"]))

        final_pool = []
        seen = set()

        def add_to_pool(lst, count):
            added = 0
            for item in lst:
                if added >= count: break
                t = tuple(sorted(item['gems']))
                if t not in seen:
                    final_pool.append(item)
                    seen.add(t)
                    added += 1
        
        add_to_pool(primary_humble, 40) 
        add_to_pool(primary_greedy, 40) 
        add_to_pool(secondary_greedy, 30) 
        add_to_pool(secondary_cheap, 20) 
        add_to_pool(tertiary_greedy, 30) 
        add_to_pool(tertiary_cheap, 20) 
        add_to_pool(fail_greedy, 15)
        add_to_pool(fail_cheap, 15)
        
        return final_pool
    except Exception as e:
        log_error(e)
        return [{"pts": 0, "will": 0, "gems": [], "counts": {}}]
        
def calculate_click(event):
    try:
        save_data()
        res_div = document.getElementById("result-area")
        if not res_div: return
        safe_msg(T("calc_wait"), "#fbbf24")
        
        inventory = {}
        for code in GEM_STATS:
            try:
                el = document.getElementById("gem_" + code)
                if el:
                    val = int(el.value)
                    if val > 0: inventory[code] = val
            except: pass
        
        core_caps = []
        primaries = []
        secondaries = []
        tertiaries = []
        
        master_el = document.getElementById("auto_master")
        is_auto = master_el.checked if master_el else True
        
        for i in range(1, 4):
            el = document.getElementById("core" + str(i))
            tgt_el = document.getElementById("target" + str(i))
            
            if el and tgt_el:
                val = int(el.value)
                core_caps.append(val)
                
                if is_auto:
                    p_tgt = TARGET_SCORES[val]
                    s_tgt = SECONDARY_SCORES[val]
                    t_tgt = TERTIARY_SCORES[val]
                else:
                    p_tgt = int(tgt_el.value)
                    s_tgt = min(SECONDARY_SCORES[val], p_tgt)
                    t_tgt = min(TERTIARY_SCORES[val], s_tgt)
                    
                primaries.append(p_tgt)
                secondaries.append(s_tgt)
                tertiaries.append(t_tgt)
        
        available_types = list(inventory.keys())
        if not available_types:
            safe_msg(T("inv_empty"), "#ef4444")
            return

        pools = []
        for i in range(3):
            candidates = get_valid_combos(core_caps[i], inventory, available_types, primaries[i], secondaries[i], tertiaries[i])
            pools.append(candidates)

        best_eval = (-1, -1, -1, -1, -1, -1, -1, -1)
        best_assign = []
        found = False

        for c1 in pools[0]:
            inv1 = inventory.copy()
            valid1 = True
            for k, v in c1["counts"].items():
                inv1[k] = inv1.get(k, 0) - v
                if 0 > inv1[k]:
                    valid1 = False
                    break
            if not valid1: continue 

            for c2 in pools[1]:
                inv2 = inv1.copy()
                valid2 = True
                for k, v in c2["counts"].items():
                    inv2[k] = inv2.get(k, 0) - v
                    if 0 > inv2[k]:
                        valid2 = False
                        break
                if not valid2: continue

                for c3 in pools[2]:
                    valid3 = True
                    for k, v in c3["counts"].items():
                        if v > inv2.get(k, 0):
                            valid3 = False
                            break
                    if not valid3: continue
                    
                    current_score = c1["pts"] + c2["pts"] + c3["pts"]
                    
                    tier_score = 0
                    if c1["pts"] >= primaries[0]: tier_score += 3
                    elif c1["pts"] >= secondaries[0]: tier_score += 2
                    elif c1["pts"] >= tertiaries[0]: tier_score += 1
                    
                    if c2["pts"] >= primaries[1]: tier_score += 3
                    elif c2["pts"] >= secondaries[1]: tier_score += 2
                    elif c2["pts"] >= tertiaries[1]: tier_score += 1
                    
                    if c3["pts"] >= primaries[2]: tier_score += 3
                    elif c3["pts"] >= secondaries[2]: tier_score += 2
                    elif c3["pts"] >= tertiaries[2]: tier_score += 1
                    
                    current_max_single = max(c1["pts"], c2["pts"], c3["pts"])

                    primary_success_count = 0
                    if c1["pts"] >= primaries[0]: primary_success_count += 1
                    if c2["pts"] >= primaries[1]: primary_success_count += 1
                    if c3["pts"] >= primaries[2]: primary_success_count += 1

                    sun_moon_14 = 1 if (c1["pts"] >= 14 and c2["pts"] >= 14) else 0
                    sun_17 = 1 if c1["pts"] >= 17 else 0
                    moon_17 = 1 if c2["pts"] >= 17 else 0
                    star_17 = 1 if c3["pts"] >= 17 else 0
                    
                    current_eval = (primary_success_count, tier_score, sun_moon_14, sun_17, moon_17, star_17, current_score, current_max_single)

                    if current_eval > best_eval:
                        best_eval = current_eval
                        best_assign = [c1, c2, c3]
                        found = True
        
        if not found:
            best_score = 0
            best_assign = []
            curr_inv = inventory.copy()
            for i in range(3):
                cands = get_valid_combos(core_caps[i], curr_inv, list(curr_inv.keys()), primaries[i], secondaries[i], tertiaries[i])
                best = cands[0] if cands else {"pts":0, "gems":[]}
                if best["gems"]:
                    for g in best["gems"]: 
                        if curr_inv.get(g,0)>0: curr_inv[g]-=1
                best_assign.append(best)
                best_score += best["pts"]
        else:
            best_score = best_eval[6]

        out_html = f"{LT}div style='text-align:center; padding-bottom:10px; border-bottom:1px solid #334155; margin-bottom:15px;'{GT}"
        out_html += f"{LT}div style='color:#38bdf8; font-weight:800; font-size:16px; text-transform:uppercase;'{GT}=== {current_char} ({current_inv_tab.upper()}) ==={LT}/div{GT}"
        out_html += f"{LT}div style='color:#10b981; font-weight:800; font-size:14px; margin-top:5px;'{GT}{T('total_pts')}: {best_score}{LT}/div{GT}"
        out_html += f"{LT}/div{GT}"
        
        all_gems = list(GEM_STATS.keys())
        core_names = ["Sun Core", "Moon Core", "Star Core"] 
        
        order_icons = ["sun_order.png", "moon_order.png", "star_order.png"]
        chaos_icons = ["sun_chaos.png", "moon_chaos.png", "star_chaos.png"]
        icons = order_icons if current_inv_tab == "order" else chaos_icons
        
        remaining_inv = inventory.copy()
        for res in best_assign:
            for g in res["gems"]:
                if remaining_inv.get(g, 0) > 0:
                    remaining_inv[g] -= 1
        
        for i, res in enumerate(best_assign):
            cap = core_caps[i]
            p_target = primaries[i]
            s_target = secondaries[i]
            t_target = tertiaries[i]
            pts = res["pts"]
            
            if pts >= p_target:
                status = f"{LT}span style='color:#10b981;'{GT}{T('success')}{LT}/span{GT}"
            elif pts >= s_target:
                status = f"{LT}span style='color:#fbbf24;'{GT}‚ö†Ô∏è ({T('sub_target')} {s_target}P){LT}/span{GT}"
            elif pts >= t_target:
                status = f"{LT}span style='color:#fbbf24;'{GT}‚ö†Ô∏è ({T('sub_target')} {t_target}P){LT}/span{GT}"
            else:
                status = f"{LT}span style='color:#ef4444;'{GT}{T('fail')}{LT}/span{GT}"
            
            out_html += f"{LT}div style='background:rgba(30,41,59,0.5); border:1px solid #334155; border-radius:10px; padding:12px; margin-bottom:12px;'{GT}"
            
            img_t = f"{LT}img src='{icons[i]}' alt='icon' style='width:24px; height:24px; vertical-align:middle; margin-right:8px; border-radius:4px;'{GT}"
            
            out_html += f"{LT}div style='display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #334155;'{GT}"
            out_html += f"{LT}div style='color:#e2e8f0; font-weight:bold; font-size:14px; display:flex; align-items:center;'{GT}{img_t}{core_names[i]} ({cap}W){LT}/div{GT}"
            out_html += f"{LT}div style='font-weight:bold; font-size:13px;'{GT}{pts} / {p_target} {status}{LT}/div{GT}"
            out_html += f"{LT}/div{GT}"
            
            gem_str = " + ".join(res['gems']) if res['gems'] else T("empty")
            out_html += f"{LT}div style='color:#94a3b8; font-size:13px;'{GT}{T('equip')}: {LT}span style='color:#f8fafc; font-weight:bold; letter-spacing:1px;'{GT}{gem_str}{LT}/span{GT}{LT}/div{GT}"
            
            if p_target > pts:
                sugs = []
                for r in range(1, 5):
                    for combo in combinations_with_replacement(all_gems, r):
                        w = sum(GEM_STATS[g]["will"] for g in combo)
                        p = sum(GEM_STATS[g]["pts"] for g in combo)
                        
                        if cap >= w and p >= p_target:
                            need = Counter(combo)
                            have_in_core = Counter(res["gems"])
                            leftovers = Counter(remaining_inv)
                            
                            total_have = have_in_core + leftovers
                            truly_missing = list((need - total_have).elements())
                            
                            cost = len(truly_missing)
                            will_diff = cap - w  
                            pts_diff = p - p_target 
                            
                            sugs.append({
                                "combo": combo, 
                                "miss": truly_missing, 
                                "cost": cost, 
                                "will_diff": will_diff, 
                                "pts_diff": pts_diff, 
                                "will": w
                            })
                
                if sugs:
                    sugs.sort(key=lambda x: (x["cost"], x["will_diff"], x["pts_diff"]))
                    s = sugs[0]
                    miss_str = ", ".join(s['miss']) if s['miss'] else T("in_inv")
                    out_html += f"{LT}div style='margin-top:10px; background:rgba(0,0,0,0.2); padding:8px; border-radius:6px; font-size:12px; line-height:1.6;'{GT}"
                    out_html += f"{LT}span style='color:#fbbf24; font-weight:bold;'{GT}üéØ {T('suggestion')}{LT}/span{GT}{LT}br{GT}"
                    out_html += f"{LT}span style='color:#94a3b8;'{GT}{T('need_find')}: {LT}/span{GT}{LT}strong style='color:white;'{GT}{miss_str}{LT}/strong{GT}{LT}br{GT}"
                    out_html += f"{LT}span style='color:#94a3b8;'{GT}{T('new_layout')}: {LT}/span{GT}{LT}strong style='color:white;'{GT}{'+'.join(s['combo'])} ({s['will']}W){LT}/strong{GT}"
                    out_html += f"{LT}/div{GT}"
                    
            out_html += f"{LT}/div{GT}"
        
        res_div.innerHTML = out_html
        res_div.style.color = "#e2e8f0"
        res_div.style.textAlign = "left"

    except Exception as e: log_error(e)
                            
def reset_click(event):
    try:
        for code in GEM_STATS:
            el = document.getElementById("gem_" + code)
            if el: el.value = "0"
        safe_msg(T("reset_msg"), "#10b981")
        save_data()
    except Exception as e: log_error(e)

def hard_reset_click(event):
    if window.confirm(T("hard_reset_warn")):
        localStorage.removeItem("astrogem_data")
        window.location.reload()

def increment_gem(event):
    try:
        code = event.currentTarget.id.split("_")[1]
        el = document.getElementById("gem_" + code)
        if el:
            val = el.value
            el.value = str(int(val) + 1 if val else 1)
            save_data()
    except Exception as e: log_error(e)

def on_gem_change(event):
    try:
        save_data()
    except Exception as e: log_error(e)

def on_master_auto_change(event):
    try:
        is_auto = event.currentTarget.checked
        for i in range(1, 4):
            box = document.getElementById(f"box-target{i}")
            if box:
                box.style.display = "none" if is_auto else "flex"
        save_data()
    except Exception as e: log_error(e)

# Sƒ∞STEM BA≈ûLATMA
try:
    gem_container = document.getElementById("gem-inputs")
    if gem_container:
        w_groups = {}
        for code, stats in GEM_STATS.items():
            w = stats['will']
            if w not in w_groups: w_groups[w] = []
            w_groups[w].append((code, stats))
            
        w_keys = list(w_groups.keys())
        w_keys.sort()
        
        for w in w_keys:
            row_div = document.createElement("div")
            row_div.className = "w-row"
            
            lbl_div = document.createElement("div")
            lbl_div.className = "w-label"
            lbl_div.innerText = str(w) + " WILLPOWER" 
            row_div.appendChild(lbl_div)
            
            for code, stats in w_groups[w]:
                color = stats['color']
                pts = stats['pts']
                
                box_div = document.createElement("div")
                box_div.className = "gem-box"
                
                icon_div = document.createElement("div")
                icon_div.className = "gem-icon"
                icon_div.style.backgroundColor = color
                icon_div.id = "icon_" + code
                icon_div.innerText = code
                box_div.appendChild(icon_div)
                
                pts_div = document.createElement("div")
                pts_div.className = "gem-pts"
                pts_div.innerText = str(pts) + "P"
                box_div.appendChild(pts_div)
                
                inp = document.createElement("input")
                inp.type = "number"
                inp.id = "gem_" + code
                inp.min = "0"
                inp.value = "0"
                box_div.appendChild(inp)
                
                row_div.appendChild(box_div)
                
            gem_container.appendChild(row_div)

    # Event Listeners (Baƒülantƒ±lar)
    for code in GEM_STATS.keys():
        icon_el = document.getElementById("icon_" + code)
        if icon_el:
            i_proxy = create_proxy(increment_gem)
            ui_proxies.append(i_proxy)
            icon_el.addEventListener("click", i_proxy)
        
        input_el = document.getElementById("gem_" + code)
        if input_el:
            change_proxy = create_proxy(on_gem_change)
            ui_proxies.append(change_proxy)
            input_el.addEventListener("change", change_proxy)

    # Core ve Target Ayar Olaylarƒ±
    master_auto_el = document.getElementById("auto_master")
    if master_auto_el:
        ap_proxy = create_proxy(on_master_auto_change)
        ui_proxies.append(ap_proxy)
        master_auto_el.addEventListener("change", ap_proxy)

    for i in range(1, 4):
        tgt_el = document.getElementById("target" + str(i))
        if tgt_el:
            tp_proxy = create_proxy(on_gem_change)
            ui_proxies.append(tp_proxy)
            tgt_el.addEventListener("change", tp_proxy)
            
        core_el = document.getElementById("core" + str(i))
        if core_el:
            cp_proxy = create_proxy(on_gem_change)
            ui_proxies.append(cp_proxy)
            core_el.addEventListener("change", cp_proxy)

    btn_order = document.getElementById("btn-inv-order")
    if btn_order:
        order_proxy = create_proxy(lambda e: switch_inv_tab("order"))
        ui_proxies.append(order_proxy)
        btn_order.addEventListener("click", order_proxy)
        
    btn_chaos = document.getElementById("btn-inv-chaos")
    if btn_chaos:
        chaos_proxy = create_proxy(lambda e: switch_inv_tab("chaos"))
        ui_proxies.append(chaos_proxy)
        btn_chaos.addEventListener("click", chaos_proxy)

    lang_btn = document.getElementById("btn-lang")
    if lang_btn:
        lang_proxy = create_proxy(toggle_lang)
        ui_proxies.append(lang_proxy)
        lang_btn.addEventListener("click", lang_proxy)

    load_data()
    
    calc_btn = document.getElementById("btn-calculate")
    if calc_btn:
        calc_proxy = create_proxy(calculate_click)
        ui_proxies.append(calc_proxy)
        calc_btn.addEventListener("click", calc_proxy)
        
    reset_btn = document.getElementById("btn-reset")
    if reset_btn:
        reset_proxy = create_proxy(reset_click)
        ui_proxies.append(reset_proxy)
        reset_btn.addEventListener("click", reset_proxy)
        
    del_btn = document.getElementById("btn-delete-char")
    if del_btn:
        delete_proxy = create_proxy(delete_character)
        ui_proxies.append(delete_proxy)
        del_btn.addEventListener("click", delete_proxy)
        
    hard_reset_btn = document.getElementById("btn-hard-reset")
    if hard_reset_btn:
        hard_reset_proxy = create_proxy(hard_reset_click)
        ui_proxies.append(hard_reset_proxy)
        hard_reset_btn.addEventListener("click", hard_reset_proxy)
    
    status_msg = document.getElementById("status-msg")
    if status_msg:
        status_msg.innerText = T("sys_ready")
        status_msg.style.color = "#10b981"

except Exception as e: 
    log_error(e)

</py-script>
</body>
</html>

