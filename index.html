<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Ark Calculator</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        body { background-color: #2c3e50; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background-color: #34495e; padding: 20px; border-radius: 8px; border: 1px solid #7f8c8d; }
        h1, h2 { text-align: center; color: #ecf0f1; margin-top: 0; }
        .gem-row { display: flex; align-items: center; margin-bottom: 8px; justify-content: space-between; }
        .gem-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; color: white; border: 2px solid white; font-size: 14px; }
        input[type="number"] { width: 60px; padding: 5px; border-radius: 4px; border: none; text-align: center; font-weight: bold; }
        select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; }
        button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .btn-calc { background-color: #27ae60; color: white; } .btn-calc:hover { background-color: #2ecc71; }
        .btn-reset { background-color: #c0392b; color: white; } .btn-reset:hover { background-color: #e74c3c; }
        #result-area { background-color: #ecf0f1; color: #2c3e50; padding: 15px; border-radius: 5px; font-family: 'Consolas', monospace; white-space: pre-wrap; height: 400px; overflow-y: auto; font-size: 14px; border: 2px solid #bdc3c7; }
        .tabs { display: flex; margin-bottom: 20px; background-color: #34495e; padding: 10px; border-radius: 8px; overflow-x: auto; gap: 5px; }
        .tab-btn { background-color: #95a5a6; color: #2c3e50; padding: 10px 15px; border: none; cursor: pointer; font-weight: bold; white-space: nowrap; border-radius: 4px; }
        .tab-btn.active { background-color: #ecf0f1; color: black; border: 2px solid #2980b9; }
        #status-msg { text-align:center; color: #f1c40f; font-weight: bold; margin-bottom: 10px; background: #222; padding: 10px; border-radius: 5px;}
        #debug-console { margin-top: 20px; background: black; color: #e74c3c; font-family: monospace; padding: 10px; border-radius: 5px; min-height: 50px; display: none; }
    </style>
</head>
<body>

    <h1>Lost Ark Astrogem Calculator</h1>
    <div id="status-msg">Sistem Yükleniyor...</div>

    <div class="tabs" id="tab-container"></div>

    <div class="container">
        <div class="panel">
            <h2>Envanter</h2>
            <div id="gem-inputs"></div>
        </div>

        <div class="panel">
            <h2>Core Ayarları</h2>
            <label>Core 1:</label>
            <select id="core1">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>
            
            <label>Core 2:</label>
            <select id="core2">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>

            <label>Core 3:</label>
            <select id="core3">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>

            <button id="btn-calculate" class="btn-calc">HESAPLA & KAYDET</button>
            <button id="btn-reset" class="btn-reset">SIFIRLA</button>
            
            <h3 style="margin-bottom: 5px;">Sonuçlar</h3>
            <div id="result-area">Sonuçlar burada görünecek...</div>
        </div>
    </div>

    <div id="debug-console">Hata Konsolu: Temiz</div>

<py-script>
from js import document, window, localStorage
from itertools import combinations_with_replacement
from collections import Counter
import json
from pyodide.ffi import create_proxy
import traceback

# --- DEBUG ---
def log_error(e):
    err_div = document.getElementById("debug-console")
    err_div.style.display = "block"
    err_div.innerHTML = f"HATA:<br>{str(e)}<br>{traceback.format_exc()}"

# --- SABİTLER ---
GEM_STATS = {
    "S": {"will": 3, "pts": 5, "color": "#e74c3c"},
    "A": {"will": 3, "pts": 4, "color": "#e67e22"},
    "B": {"will": 3, "pts": 3, "color": "#f1c40f"},
    "C": {"will": 4, "pts": 5, "color": "#2ecc71"},
    "D": {"will": 4, "pts": 4, "color": "#27ae60"},
    "E": {"will": 4, "pts": 3, "color": "#16a085"},
    "F": {"will": 5, "pts": 5, "color": "#3498db"},
    "G": {"will": 5, "pts": 4, "color": "#2980b9"},
    "H": {"will": 5, "pts": 3, "color": "#9b59b6"},
    "K": {"will": 6, "pts": 5, "color": "#bdc3c7"},
}
TARGET_SCORES = {12: 14, 15: 17, 17: 17}
DEFAULT_CHARS = ["Çar 1", "Çar 2", "Çar 3", "Çar 4", "Çar 5", "Çar 6"]

current_char = DEFAULT_CHARS[0]
app_data = {}

# --- ALGORİTMA ---
def get_valid_combos(cap, inventory, available_types, target_score):
    all_combos = []
    
    # 1. Kombinasyonları Bul
    for r in range(1, 5):
        for combo_tuple in combinations_with_replacement(available_types, r):
            w = sum(GEM_STATS[g]["will"] for g in combo_tuple)
            if w > cap: continue
            
            counts = Counter(combo_tuple)
            if all(inventory.get(g, 0) >= c for g, c in counts.items()):
                p = sum(GEM_STATS[g]["pts"] for g in combo_tuple)
                all_combos.append({"pts": p, "will": w, "gems": list(combo_tuple)})

    # 2. Gruplara Ayır
    success_combos = [c for c in all_combos if c['pts'] >= target_score]
    fail_combos = [c for c in all_combos if c['pts'] < target_score]

    # 3. Sıralamalar (Çeşitlilik İçin)
    greedy_list = sorted(success_combos, key=lambda x: -x["pts"]) # 20, 19...
    humble_list = sorted(success_combos, key=lambda x: x["pts"])  # 17, 18...
    fail_list = sorted(fail_combos, key=lambda x: -x["pts"])

    # 4. Havuz Birleştirme
    final_pool = []
    seen = set()

    def add_to_pool(lst, count):
        added = 0
        for item in lst:
            if added >= count: break
            t = tuple(sorted(item['gems']))
            if t not in seen:
                final_pool.append(item)
                seen.add(t)
                added += 1
    
    add_to_pool(humble_list, 40) # Önce tam hedefler
    add_to_pool(greedy_list, 40) # Sonra yüksek puanlar
    add_to_pool(fail_list, 20)
    
    return final_pool

# --- UI FONKSİYONLARI ---
def render_tabs():
    container = document.getElementById("tab-container")
    container.innerHTML = ""
    for name in app_data.keys():
        btn = document.createElement("button")
        btn.innerText = name
        btn.className = "tab-btn"
        if name == current_char: btn.classList.add("active")
        
        click_proxy = create_proxy(lambda e, n=name: switch_tab(n))
        dbl_click_proxy = create_proxy(lambda e, n=name: rename_tab(n))
        btn.addEventListener("click", click_proxy)
        btn.addEventListener("dblclick", dbl_click_proxy)
        container.appendChild(btn)

def switch_tab(new_name):
    global current_char
    try:
        save_data()
        current_char = new_name
        render_tabs()
        load_ui_for_char(current_char)
        document.getElementById("result-area").innerHTML = f"--- {current_char} Yüklendi ---"
    except Exception as e: log_error(e)

def rename_tab(old_name):
    try:
        new_name = window.prompt(f"Karakter adını değiştir ({old_name}):", old_name)
        if new_name and new_name.strip() and new_name != old_name:
            if new_name == "Boisy":
                window.alert("SEN KİM KÖPEK KOSKOCA BİLGEHAN BEYİN ÇARININ İSMİNİ DEĞİŞTİRMEYE CÜRRET EDİYOSUN")
            elif new_name == "Aelathea":
                window.alert("GAY")
            data = app_data.pop(old_name)
            app_data[new_name] = data
            global current_char
            if current_char == old_name: current_char = new_name
            save_data()
            render_tabs()
    except Exception as e: log_error(e)

def load_ui_for_char(name):
    data = app_data.get(name, {"inventory": {}, "cores": [0,0,0]})
    inv = data.get("inventory", {})
    cores = data.get("cores", [0,0,0])
    for code in GEM_STATS:
        el = document.getElementById(f"gem_{code}")
        if el: el.value = inv.get(code, 0)
    document.getElementById("core1").selectedIndex = cores[0]
    document.getElementById("core2").selectedIndex = cores[1]
    document.getElementById("core3").selectedIndex = cores[2]

def get_ui_data():
    inv = {}
    for code in GEM_STATS:
        el = document.getElementById(f"gem_{code}")
        val = el.value
        inv[code] = int(val) if val else 0
    return {"inventory": inv, "cores": [
        document.getElementById("core1").selectedIndex,
        document.getElementById("core2").selectedIndex,
        document.getElementById("core3").selectedIndex
    ]}

def save_data():
    global app_data
    app_data[current_char] = get_ui_data()
    localStorage.setItem("astrogem_data", json.dumps(app_data))

def load_data():
    global app_data
    try:
        stored = localStorage.getItem("astrogem_data")
        if stored: app_data = json.loads(stored)
        else: app_data = {name: {"inventory": {}, "cores": [0,0,0]} for name in DEFAULT_CHARS}
        for name in DEFAULT_CHARS:
            if name not in app_data: app_data[name] = {"inventory": {}, "cores": [0,0,0]}
        render_tabs()
        load_ui_for_char(current_char)
    except Exception as e: log_error(e)

def calculate_click(event):
    try:
        save_data()
        res_div = document.getElementById("result-area")
        res_div.innerHTML = "Hesaplanıyor... Lütfen bekleyin. (Zirve Öncelikli Mod)"
        
        inventory = {}
        for code in GEM_STATS:
            try:
                val = int(document.getElementById(f"gem_{code}").value)
                if val > 0: inventory[code] = val
            except: pass
        
        core_caps = []
        targets = []
        for i in range(1, 4):
            val = int(document.getElementById(f"core{i}").value)
            core_caps.append(val)
            targets.append(TARGET_SCORES[val])
        
        available_types = list(inventory.keys())
        if not available_types:
            res_div.innerHTML = "Envanter boş."
            return

        pools = []
        for i in range(3):
            candidates = get_valid_combos(core_caps[i], inventory, available_types, targets[i])
            pools.append(candidates)

        best_score = -1
        best_success_count = -1
        best_max_single = -1 # YENİ KRİTER
        best_assign = []
        found = False

        # OPTİMİZASYON DÖNGÜSÜ
        for c1 in pools[0]:
            for c2 in pools[1]:
                for c3 in pools[2]:
                    needed = Counter(c1["gems"] + c2["gems"] + c3["gems"])
                    
                    if all(inventory.get(g, 0) >= c for g, c in needed.items()):
                        current_score = c1["pts"] + c2["pts"] + c3["pts"]
                        
                        success_count = 0
                        if c1["pts"] >= targets[0]: success_count += 1
                        if c2["pts"] >= targets[1]: success_count += 1
                        if c3["pts"] >= targets[2]: success_count += 1
                        
                        # Tekil en yüksek puanı bul (Örn: 19, 17, 17 -> Max 19)
                        current_max_single = max(c1["pts"], c2["pts"], c3["pts"])

                        # 1. Kriter: Daha fazla Başarı
                        if success_count > best_success_count:
                            best_success_count = success_count
                            best_score = current_score
                            best_max_single = current_max_single
                            best_assign = [c1, c2, c3]
                            found = True
                        
                        # 2. Kriter: Başarı eşitse, Toplam Puan
                        elif success_count == best_success_count:
                            if current_score > best_score:
                                best_score = current_score
                                best_max_single = current_max_single
                                best_assign = [c1, c2, c3]
                                found = True
                            
                            # 3. Kriter: Toplam Puan da eşitse, EN YÜKSEK TEKİL PUAN (PEAK)
                            elif current_score == best_score:
                                if current_max_single > best_max_single:
                                    best_max_single = current_max_single
                                    best_assign = [c1, c2, c3]
                                    found = True
        
        if not found:
            best_score = 0
            best_assign = []
            curr_inv = inventory.copy()
            for i in range(3):
                cands = get_valid_combos(core_caps[i], curr_inv, list(curr_inv.keys()), targets[i])
                best = cands[0] if cands else {"pts":0, "gems":[]}
                if best["gems"]:
                    for g in best["gems"]: 
                        if curr_inv.get(g,0)>0: curr_inv[g]-=1
                best_assign.append(best)
                best_score += best["pts"]

        output = f"=== {current_char} SONUÇLARI ===\n"
        output += f"TOPLAM PUAN: {best_score}\n"
        
        all_gems = list(GEM_STATS.keys())
        
        for i, res in enumerate(best_assign):
            cap = core_caps[i]
            target = targets[i]
            pts = res["pts"]
            status = "✅" if pts >= target else "❌"
            
            output += f"\nCore {i+1} ({cap}W): {pts}/{target} {status}\n"
            gem_str = "+".join(res['gems']) if res['gems'] else 'BOŞ'
            output += f"Tak: {gem_str}\n"
            
            if pts < target:
                output += "[ÖNERİLER]\n"
                sugs = []
                for r in range(1, 5):
                    for combo in combinations_with_replacement(all_gems, r):
                        w = sum(GEM_STATS[g]["will"] for g in combo)
                        p = sum(GEM_STATS[g]["pts"] for g in combo)
                        if w <= cap and p >= target:
                            need = Counter(combo)
                            have = Counter(res["gems"])
                            missing = list((need - have).elements())
                            diff = sum(GEM_STATS[g]["pts"] for g in missing)
                            sugs.append({"combo": combo, "miss": missing, "cost": len(missing), "diff": diff, "will": w})
                
                if sugs:
                    sugs.sort(key=lambda x: (x["cost"], x["diff"], x["will"]))
                    cnt = 0
                    shown = []
                    for s in sugs:
                        cstr = str(sorted(s["combo"]))
                        if cstr in shown: continue
                        shown.append(cstr)
                        cnt += 1
                        output += f" {cnt}. Bul: {','.join(s['miss'])}\n"
                        output += f"    Hedef: {'+'.join(s['combo'])}\n"
                        if cnt >= 1: break
            output += "-"*30 + "\n"
        
        res_div.innerHTML = output

    except Exception as e: log_error(e)

def reset_click(event):
    try:
        for code in GEM_STATS:
            el = document.getElementById(f"gem_{code}")
            if el: el.value = 0
        document.getElementById("result-area").innerHTML = "Sıfırlandı."
        save_data()
    except Exception as e: log_error(e)

# BAŞLANGIÇ
try:
    gem_container = document.getElementById("gem-inputs")
    gem_container.innerHTML = ""
    for code, stats in GEM_STATS.items():
        div = document.createElement("div")
        div.className = "gem-row"
        div.innerHTML = f'''
            <div style="display:flex; align-items:center;">
                <div class="gem-icon" style="background-color: {stats['color']}">{code}</div>
                <span>{stats['will']}W / {stats['pts']}P</span>
            </div>
            <input type="number" id="gem_{code}" min="0" value="0">
        '''
        gem_container.appendChild(div)

    load_data()
    calc_proxy = create_proxy(calculate_click)
    reset_proxy = create_proxy(reset_click)
    document.getElementById("btn-calculate").addEventListener("click", calc_proxy)
    document.getElementById("btn-reset").addEventListener("click", reset_proxy)
    document.getElementById("status-msg").innerHTML = "Sistem Hazır!"
    document.getElementById("status-msg").style.color = "#2ecc71"
except Exception as e: log_error(e)

</py-script>
</body>
</html>