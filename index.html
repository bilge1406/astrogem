<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Ark Astrogem Calculator</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        body { background-color: #2c3e50; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        /* ANA D√úZEN (LAYOUT) - 3 S√úTUNLU YAPI */
        .container { 
            max-width: 1300px; 
            margin: 0 auto; 
            display: grid; 
            /* 1. Core Ayarlarƒ± (300px) | 2. Envanter (300px) | 3. Sonu√ßlar (Kalan t√ºm alan) */
            grid-template-columns: 300px 300px 1fr; 
            gap: 20px; 
            align-items: start;
        }

        /* Ekran k√º√ß√ºl√ºrse alt alta ge√ßsin (Mobil/K√º√ß√ºk ekran uyumluluƒüu) */
        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; }
        }

        .panel { background-color: #34495e; padding: 20px; border-radius: 8px; border: 1px solid #7f8c8d; }
        
        h1, h2, h3 { text-align: center; color: #ecf0f1; margin-top: 0; }
        
        /* ENVANTER STƒ∞LLERƒ∞ */
        .gem-row { display: flex; align-items: center; margin-bottom: 8px; justify-content: space-between; }
        .gem-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; color: white; border: 2px solid white; font-size: 14px; }
        input[type="number"] { width: 60px; padding: 5px; border-radius: 4px; border: none; text-align: center; font-weight: bold; font-size: 14px; }
        
        /* INPUT VE BUTONLAR */
        select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; background: #ecf0f1; border: none; font-weight: bold; }
        label { font-weight: bold; color: #bdc3c7; display: block; margin-bottom: 3px; font-size: 14px; }
        
        button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-calc { background-color: #27ae60; color: white; font-size: 16px; padding: 15px; } .btn-calc:hover { background-color: #2ecc71; }
        .btn-reset { background-color: #e67e22; color: white; } .btn-reset:hover { background-color: #d35400; }
        .btn-delete { background-color: #c0392b; color: white; } .btn-delete:hover { background-color: #e74c3c; }
        .btn-hard-reset { background-color: transparent; color: #7f8c8d; border: 1px dashed #7f8c8d; margin-top: 25px; font-size: 12px; padding: 10px; } 
        .btn-hard-reset:hover { background-color: #c0392b; color: white; border-color: #c0392b; }
        
        /* SONU√á ALANI - Y√úKSEKLƒ∞K Dƒ∞NAMƒ∞K YAPILDI */
        #result-area { 
            background-color: #ecf0f1; 
            color: #2c3e50; 
            padding: 20px; 
            border-radius: 5px; 
            font-family: 'Consolas', monospace; 
            white-space: pre-wrap; 
            min-height: 200px; /* √áok k√º√ß√ºlmemesi i√ßin */
            max-height: 650px; /* √áok uzayƒ±p ekranƒ± ta≈üƒ±rmamasƒ± i√ßin */
            overflow-y: auto; 
            font-size: 15px; 
            border: 2px solid #bdc3c7; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* SEKMELER */
        .tabs { display: flex; margin-bottom: 20px; background-color: #34495e; padding: 10px; border-radius: 8px; overflow-x: auto; gap: 5px; align-items: center; }
        .tab-btn { background-color: #95a5a6; color: #2c3e50; padding: 8px 15px; border: none; cursor: pointer; font-weight: bold; white-space: nowrap; border-radius: 4px; margin-top: 0; font-size: 13px; width: auto; }
        .tab-btn.active { background-color: #ecf0f1; color: black; border-bottom: 4px solid #2980b9; }
        .add-tab-btn { background-color: #27ae60; color: white; border-radius: 20px; padding: 8px 15px;}
        
        #status-msg { text-align:center; color: #f1c40f; font-weight: bold; margin-bottom: 10px; background: #222; padding: 10px; border-radius: 5px;}
        #debug-console { margin-top: 20px; background: black; color: #e74c3c; font-family: monospace; padding: 10px; border-radius: 5px; min-height: 50px; display: none; }
        #joke-overlay {
            display: none; /* Ba≈ülangƒ±√ßta gizli */
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); /* Siyah arka plan */
            z-index: 9999; /* En √ºstte durur */
            justify-content: center;
            align-items: center; 
            flex-direction: column;
        }
        #joke-gif { max-width: 80%; max-height: 60vh; border-radius: 10px; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        #joke-text { color: white; font-size: 28px; margin-top: 20px; text-align: center; text-shadow: 2px 2px 4px #000; font-weight: bold; padding: 0 20px; }
        #joke-close { width: 200px; margin-top: 30px; padding: 15px; font-size: 18px; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 5px; font-weight: bold; }
        #joke-close:hover { background: #c0392b; }
    </style>
</head>
<body>

<div id="joke-overlay">
        <img id="joke-gif" src="" alt="S√ºrpriz">
        <div id="joke-text"></div>
        <button id="joke-close" onclick="document.getElementById('joke-overlay').style.display='none'">KAPAT</button>
</div>
    
    <h1>Lost Ark Astrogem Calculator</h1>
    <div id="status-msg">Sistem Y√ºkleniyor...</div>

    <div class="tabs" id="tab-container"></div>

    <div class="container">
        
        <div class="panel">
            <h2>Core Ayarlarƒ±</h2>
            <label>Core 1:</label>
            <select id="core1">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>
            
            <label>Core 2:</label>
            <select id="core2">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>

            <label>Core 3:</label>
            <select id="core3">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>

            <hr style="border-color: #7f8c8d; margin: 15px 0;">

            <button id="btn-calculate" class="btn-calc">HESAPLA & KAYDET</button>
            
            <div style="display: flex; gap: 10px;">
                <button id="btn-reset" class="btn-reset">‚Ü∫ SIFIRLA</button>
                <button id="btn-delete-char" class="btn-delete">üóëÔ∏è √áARI Sƒ∞L</button>
            </div>

            <button id="btn-hard-reset" class="btn-hard-reset">‚ö† FABRƒ∞KA AYARLARI (T√ºm Verileri Sil)</button>
        </div>

        <div class="panel">
            <h2>Envanter</h2>
            <div id="gem-inputs"></div>
        </div>

        <div class="panel">
            <h2>Analiz Sonu√ßlarƒ±</h2>
            <div id="result-area">Sonu√ßlar burada g√∂r√ºnecek...</div>
        </div>

    </div>

    <div id="debug-console">Hata Konsolu: Temiz</div>

<py-script>
from js import document, window, localStorage
from itertools import combinations_with_replacement
from collections import Counter
import json
from pyodide.ffi import create_proxy
import traceback

def log_error(e):
    err_div = document.getElementById("debug-console")
    err_div.style.display = "block"
    err_div.innerHTML = f"HATA:<br>{str(e)}<br>{traceback.format_exc()}"

# --- SABƒ∞TLER ---
GEM_STATS = {
    "S": {"will": 3, "pts": 5, "color": "#e74c3c"},
    "A": {"will": 3, "pts": 4, "color": "#e67e22"},
    "B": {"will": 3, "pts": 3, "color": "#f1c40f"},
    "C": {"will": 4, "pts": 5, "color": "#2ecc71"},
    "D": {"will": 4, "pts": 4, "color": "#27ae60"},
    "E": {"will": 4, "pts": 3, "color": "#16a085"},
    "F": {"will": 5, "pts": 5, "color": "#3498db"},
    "G": {"will": 5, "pts": 4, "color": "#2980b9"},
    "H": {"will": 5, "pts": 3, "color": "#9b59b6"},
    "K": {"will": 6, "pts": 5, "color": "#bdc3c7"},
}
TARGET_SCORES = {12: 14, 15: 17, 17: 17}

current_char = ""
app_data = {}

# --- YENƒ∞: ≈ûAKA (GIF) TETƒ∞KLEME FONKSƒ∞YONU ---
def check_for_joke(name):
    overlay = document.getElementById("joke-overlay")
    gif = document.getElementById("joke-gif")
    text = document.getElementById("joke-text")

    if name == "Boisy":
        text.innerHTML= "NASI Sƒ∞TE YAPMI≈ûIM AMA √áOK ƒ∞Yƒ∞ Dƒ∞ Mƒ∞"
        gif.src = "chaewon.gif"
        overlay.style.display = "flex"
                
    elif name == "Aelathea":
        text.innerHTML= "NASI Sƒ∞TE YAPMI≈ûIM AMA √áOK ƒ∞Yƒ∞ Dƒ∞ Mƒ∞"
        gif.src = "chaewon.gif"
        overlay.style.display = "flex"
    
    if name == "Abd√ºllrezzak":
        text.innerHTML= "REAPER 1760TAN SONRA A√áILIYOMU≈û"
    
    elif name == "Scarleon":
        text.innerHTML= "ESO WARDANCER GAAAAAAANG"

# --- Dƒ∞NAMƒ∞K SEKME FONKSƒ∞YONLARI ---
def add_character(event=None):
    try:
        new_name = window.prompt("Yeni karakterin adƒ±nƒ± girin:")
        if new_name and new_name.strip():
            new_name = new_name.strip()
            if new_name in app_data:
                window.alert("Bu isimde bir karakter zaten var!")
                return

            check_for_joke(new_name)
                
            app_data[new_name] = {"inventory": {}, "cores": [0,0,0]}
            global current_char
            current_char = new_name
            save_data()
            render_tabs()
            load_ui_for_char(current_char)
            document.getElementById("result-area").innerHTML = f"--- '{current_char}' olu≈üturuldu ---"
    except Exception as e: log_error(e)

def delete_character(event=None):
    global current_char
    try:
        if window.confirm(f"'{current_char}' isimli karakteri silmek istediƒüinize emin misiniz?"):
            del app_data[current_char]
            if not app_data:
                app_data["Karakter 1"] = {"inventory": {}, "cores": [0,0,0]}
            current_char = list(app_data.keys())[0]
            save_data()
            render_tabs()
            load_ui_for_char(current_char)
            document.getElementById("result-area").innerHTML = f"Karakter silindi.\n--- {current_char} Y√ºklendi ---"
    except Exception as e: log_error(e)

def render_tabs():
    container = document.getElementById("tab-container")
    container.innerHTML = ""
    for name in app_data.keys():
        btn = document.createElement("button")
        btn.innerText = name
        btn.className = "tab-btn"
        if name == current_char: btn.classList.add("active")
        click_proxy = create_proxy(lambda e, n=name: switch_tab(n))
        dbl_click_proxy = create_proxy(lambda e, n=name: rename_tab(n))
        btn.addEventListener("click", click_proxy)
        btn.addEventListener("dblclick", dbl_click_proxy)
        container.appendChild(btn)
        
    add_btn = document.createElement("button")
    add_btn.innerText = "‚ûï Ekle"
    add_btn.className = "tab-btn add-tab-btn"
    add_btn_proxy = create_proxy(add_character)
    add_btn.addEventListener("click", add_btn_proxy)
    container.appendChild(add_btn)

def switch_tab(new_name):
    global current_char
    try:
        save_data()
        current_char = new_name
        render_tabs()
        load_ui_for_char(current_char)
        document.getElementById("result-area").innerHTML = f"--- {current_char} Y√ºklendi ---"
    except Exception as e: log_error(e)

def rename_tab(old_name):
    try:
        new_name = window.prompt(f"Karakter adƒ±nƒ± deƒüi≈ütir ({old_name}):", old_name)
        if new_name and new_name.strip() and new_name != old_name:
            check_for_joke(new_name)
            data = app_data.pop(old_name)
            app_data[new_name] = data
            global current_char
            if current_char == old_name: current_char = new_name
            save_data()
            render_tabs()
    except Exception as e: log_error(e)

# --- VERƒ∞ VE Y√úKLEME ---
def load_ui_for_char(name):
    data = app_data.get(name, {"inventory": {}, "cores": [0,0,0]})
    inv = data.get("inventory", {})
    cores = data.get("cores", [0,0,0])
    for code in GEM_STATS:
        el = document.getElementById(f"gem_{code}")
        if el: el.value = inv.get(code, 0)
    document.getElementById("core1").selectedIndex = cores[0]
    document.getElementById("core2").selectedIndex = cores[1]
    document.getElementById("core3").selectedIndex = cores[2]

def get_ui_data():
    inv = {}
    for code in GEM_STATS:
        el = document.getElementById(f"gem_{code}")
        val = el.value
        inv[code] = int(val) if val else 0
    return {"inventory": inv, "cores": [
        document.getElementById("core1").selectedIndex,
        document.getElementById("core2").selectedIndex,
        document.getElementById("core3").selectedIndex
    ]}

def save_data():
    global app_data
    app_data[current_char] = get_ui_data()
    localStorage.setItem("astrogem_data", json.dumps(app_data))

def load_data():
    global app_data, current_char
    try:
        stored = localStorage.getItem("astrogem_data")
        if stored: 
            app_data = json.loads(stored)
            if not app_data: app_data = {"Karakter 1": {"inventory": {}, "cores": [0,0,0]}}
        else: 
            app_data = {"Karakter 1": {"inventory": {}, "cores": [0,0,0]}}
        current_char = list(app_data.keys())[0]
        render_tabs()
        load_ui_for_char(current_char)
    except Exception as e: log_error(e)

# --- ALGORƒ∞TMA ---
def get_valid_combos(cap, inventory, available_types, target_score):
    all_combos = []
    for r in range(1, 5):
        for combo_tuple in combinations_with_replacement(available_types, r):
            w = sum(GEM_STATS[g]["will"] for g in combo_tuple)
            if w > cap: continue
            counts = Counter(combo_tuple)
            if all(inventory.get(g, 0) >= c for g, c in counts.items()):
                p = sum(GEM_STATS[g]["pts"] for g in combo_tuple)
                all_combos.append({"pts": p, "will": w, "gems": list(combo_tuple)})

    success_combos = [c for c in all_combos if c['pts'] >= target_score]
    fail_combos = [c for c in all_combos if c['pts'] < target_score]

    greedy_list = sorted(success_combos, key=lambda x: -x["pts"]) 
    humble_list = sorted(success_combos, key=lambda x: x["pts"])  
    fail_list = sorted(fail_combos, key=lambda x: -x["pts"])

    final_pool = []
    seen = set()

    def add_to_pool(lst, count):
        added = 0
        for item in lst:
            if added >= count: break
            t = tuple(sorted(item['gems']))
            if t not in seen:
                final_pool.append(item)
                seen.add(t)
                added += 1
    
    add_to_pool(humble_list, 40) 
    add_to_pool(greedy_list, 40) 
    add_to_pool(fail_list, 20)
    
    return final_pool

def calculate_click(event):
    try:
        save_data()
        res_div = document.getElementById("result-area")
        res_div.innerHTML = "Hesaplanƒ±yor... L√ºtfen bekleyin."
        
        inventory = {}
        for code in GEM_STATS:
            try:
                val = int(document.getElementById(f"gem_{code}").value)
                if val > 0: inventory[code] = val
            except: pass
        
        core_caps = []
        targets = []
        for i in range(1, 4):
            val = int(document.getElementById(f"core{i}").value)
            core_caps.append(val)
            targets.append(TARGET_SCORES[val])
        
        available_types = list(inventory.keys())
        if not available_types:
            res_div.innerHTML = "Envanter bo≈ü."
            return

        pools = []
        for i in range(3):
            candidates = get_valid_combos(core_caps[i], inventory, available_types, targets[i])
            pools.append(candidates)

        best_score = -1
        best_success_count = -1
        best_max_single = -1
        best_assign = []
        found = False

        for c1 in pools[0]:
            for c2 in pools[1]:
                for c3 in pools[2]:
                    needed = Counter(c1["gems"] + c2["gems"] + c3["gems"])
                    
                    if all(inventory.get(g, 0) >= c for g, c in needed.items()):
                        current_score = c1["pts"] + c2["pts"] + c3["pts"]
                        
                        success_count = 0
                        if c1["pts"] >= targets[0]: success_count += 1
                        if c2["pts"] >= targets[1]: success_count += 1
                        if c3["pts"] >= targets[2]: success_count += 1
                        
                        current_max_single = max(c1["pts"], c2["pts"], c3["pts"])

                        if success_count > best_success_count:
                            best_success_count = success_count
                            best_score = current_score
                            best_max_single = current_max_single
                            best_assign = [c1, c2, c3]
                            found = True
                        elif success_count == best_success_count:
                            if current_score > best_score:
                                best_score = current_score
                                best_max_single = current_max_single
                                best_assign = [c1, c2, c3]
                                found = True
                            elif current_score == best_score:
                                if current_max_single > best_max_single:
                                    best_max_single = current_max_single
                                    best_assign = [c1, c2, c3]
                                    found = True
        
        if not found:
            best_score = 0
            best_assign = []
            curr_inv = inventory.copy()
            for i in range(3):
                cands = get_valid_combos(core_caps[i], curr_inv, list(curr_inv.keys()), targets[i])
                best = cands[0] if cands else {"pts":0, "gems":[]}
                if best["gems"]:
                    for g in best["gems"]: 
                        if curr_inv.get(g,0)>0: curr_inv[g]-=1
                best_assign.append(best)
                best_score += best["pts"]

        output = f"=== {current_char} SONU√áLARI ===\n"
        output += f"TOPLAM PUAN: {best_score}\n"
        
        all_gems = list(GEM_STATS.keys())
        
        for i, res in enumerate(best_assign):
            cap = core_caps[i]
            target = targets[i]
            pts = res["pts"]
            status = "‚úÖ" if pts >= target else "‚ùå"
            
            output += f"\nCore {i+1} ({cap}W): {pts}/{target} {status}\n"
            gem_str = "+".join(res['gems']) if res['gems'] else 'BO≈û'
            output += f"Tak: {gem_str}\n"
            
            if pts < target:
                output += "[√ñNERƒ∞LER]\n"
                sugs = []
                for r in range(1, 5):
                    for combo in combinations_with_replacement(all_gems, r):
                        w = sum(GEM_STATS[g]["will"] for g in combo)
                        p = sum(GEM_STATS[g]["pts"] for g in combo)
                        if w <= cap and p >= target:
                            need = Counter(combo)
                            have = Counter(res["gems"])
                            missing = list((need - have).elements())
                            diff = sum(GEM_STATS[g]["pts"] for g in missing)
                            sugs.append({"combo": combo, "miss": missing, "cost": len(missing), "diff": diff, "will": w})
                
                if sugs:
                    sugs.sort(key=lambda x: (x["cost"], x["diff"], x["will"]))
                    cnt = 0
                    shown = []
                    for s in sugs:
                        cstr = str(sorted(s["combo"]))
                        if cstr in shown: continue
                        shown.append(cstr)
                        cnt += 1
                        output += f" {cnt}. Bul: {','.join(s['miss'])}\n"
                        output += f"    Hedef: {'+'.join(s['combo'])}\n"
                        if cnt >= 1: break
            output += "-"*30 + "\n"
        
        res_div.innerHTML = output

    except Exception as e: log_error(e)

def reset_click(event):
    try:
        for code in GEM_STATS:
            el = document.getElementById(f"gem_{code}")
            if el: el.value = 0
        document.getElementById("result-area").innerHTML = "Sayƒ±lar Sƒ±fƒ±rlandƒ±."
        save_data()
    except Exception as e: log_error(e)

def hard_reset_click(event):
    if window.confirm("Dƒ∞KKAT: T√ºm karakterler ve veriler silinecek. Emin misiniz?"):
        localStorage.removeItem("astrogem_data")
        window.location.reload()

# BA≈ûLANGI√á
try:
    gem_container = document.getElementById("gem-inputs")
    gem_container.innerHTML = ""
    for code, stats in GEM_STATS.items():
        div = document.createElement("div")
        div.className = "gem-row"
        div.innerHTML = f'''
            <div style="display:flex; align-items:center;">
                <div class="gem-icon" style="background-color: {stats['color']}">{code}</div>
                <span>{stats['will']}W / {stats['pts']}P</span>
            </div>
            <input type="number" id="gem_{code}" min="0" value="0">
        '''
        gem_container.appendChild(div)

    load_data()
    calc_proxy = create_proxy(calculate_click)
    reset_proxy = create_proxy(reset_click)
    delete_proxy = create_proxy(delete_character)
    hard_reset_proxy = create_proxy(hard_reset_click)
    
    document.getElementById("btn-calculate").addEventListener("click", calc_proxy)
    document.getElementById("btn-reset").addEventListener("click", reset_proxy)
    document.getElementById("btn-delete-char").addEventListener("click", delete_proxy)
    document.getElementById("btn-hard-reset").addEventListener("click", hard_reset_proxy)
    
    document.getElementById("status-msg").innerHTML = "Sistem Hazƒ±r! üéâ"
    document.getElementById("status-msg").style.color = "#2ecc71"
except Exception as e: log_error(e)

</py-script>
</body>
</html>
