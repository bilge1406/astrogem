<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Ark Astrogem Calculator</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        /* GENEL AYARLAR */
        body { 
            background-color: #0f172a; /* √áok koyu lacivert/gri */
            color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px 20px 60px 20px; 
            background-image: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%);
            background-attachment: fixed;
        }
        
        /* BA≈ûLIK */
        h1 { 
            text-align: center; 
            font-size: 2.8rem;
            font-weight: 800;
            margin-top: 10px;
            margin-bottom: 5px; 
            background: linear-gradient(to right, #38bdf8, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
        }
        
        #status-msg { text-align:center; color: #fbbf24; font-weight: 600; font-size: 14px; margin-bottom: 25px; letter-spacing: 0.5px;}
        
        /* ANA D√úZEN (LAYOUT) */
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: 320px 320px 1fr; 
            gap: 25px; 
            align-items: start;
        }

        @media (max-width: 1100px) {
            .container { grid-template-columns: 1fr; }
        }

        /* PANELLER */
        .panel { 
            background-color: #1e293b; 
            padding: 25px; 
            border-radius: 16px; 
            border: 1px solid #334155; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3), 0 8px 10px -6px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(to right, #334155, #475569);
        }

        .panel:nth-child(1)::before { background: linear-gradient(to right, #f59e0b, #ef4444); } /* Core Ayarlarƒ± */
        .panel:nth-child(2)::before { background: linear-gradient(to right, #3b82f6, #8b5cf6); } /* Envanter */
        .panel:nth-child(3)::before { background: linear-gradient(to right, #10b981, #3b82f6); } /* Sonu√ßlar */
        
        h2 { color: #f1f5f9; margin-top: 0; font-size: 1.3rem; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;}
        
        /* ENVANTER STƒ∞LLERƒ∞ */
        .gem-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 12px; 
            justify-content: space-between; 
            background-color: #0f172a;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #1e293b;
            transition: all 0.2s ease;
        }
        .gem-row:hover { border-color: #475569; transform: translateX(2px); }
        .gem-icon { 
            width: 32px; height: 32px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 800; margin-right: 12px; color: white; 
            font-size: 14px;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* INPUT VE SELECTS */
        input[type="number"], select { 
            background-color: #0f172a; 
            color: #f8fafc; 
            border: 1px solid #334155; 
            border-radius: 8px; 
            padding: 10px; 
            font-family: 'Inter', sans-serif;
            font-weight: 600; 
            font-size: 14px; 
            transition: all 0.2s ease;
        }
        input[type="number"] { width: 65px; text-align: center; }
        select { width: 100%; margin-bottom: 15px; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        label { font-weight: 600; color: #94a3b8; display: block; margin-bottom: 5px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;}
        
        /* BUTONLAR */
        button { 
            width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 10px; 
            font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .btn-calc { 
            background: linear-gradient(135deg, #10b981, #059669); color: white; 
            font-size: 16px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); 
            margin-top: 20px;
        } 
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); background: linear-gradient(135deg, #34d399, #10b981); }
        
        .btn-reset { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; } 
        .btn-reset:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3); }
        
        .btn-delete { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; } 
        .btn-delete:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(239, 68, 68, 0.3); }
        
        .btn-hard-reset { 
            background-color: transparent; color: #64748b; border: 1px dashed #475569; 
            margin-top: 30px; font-size: 12px; padding: 12px; box-shadow: none;
        } 
        .btn-hard-reset:hover { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        
        /* SONU√á ALANI */
        #result-area { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            padding: 20px; 
            border-radius: 10px; 
            font-family: 'Consolas', 'Courier New', monospace; 
            white-space: pre-wrap; 
            min-height: 200px; max-height: 650px; overflow-y: auto; 
            font-size: 14px; line-height: 1.5;
            border: 1px solid #334155; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* SEKMELER (TABS) */
        .tabs { 
            display: flex; margin-bottom: 30px; background-color: transparent; 
            padding: 0; border-radius: 0; overflow-x: auto; gap: 10px; align-items: center; 
            justify-content: center;
        }
        .tab-btn { 
            background-color: #1e293b; color: #94a3b8; padding: 10px 20px; 
            border: 1px solid #334155; border-radius: 30px; font-weight: 600; 
            font-size: 13px; width: auto; margin: 0; text-transform: none; letter-spacing: normal;
        }
        .tab-btn:hover { background-color: #334155; color: white; }
        .tab-btn.active { 
            background: linear-gradient(135deg, #38bdf8, #3b82f6); 
            color: white; border: none; 
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); 
        }
        .add-tab-btn { 
            background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px dashed #10b981;
        }
        .add-tab-btn:hover { background: #10b981; color: white; }
        
        #debug-console { margin-top: 20px; background: #000; color: #ef4444; font-family: monospace; padding: 15px; border-radius: 8px; border: 1px solid #ef4444; min-height: 50px; display: none; }
        
        /* ≈ûAKA (GIF) EKRANI STƒ∞LLERƒ∞ */
        #joke-overlay {
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(5px);
            z-index: 9999; 
            justify-content: center;
            align-items: center; 
            flex-direction: column;
        }
        #joke-gif { max-width: 80%; max-height: 60vh; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 2px solid #38bdf8; }
        #joke-text { color: white; font-size: 32px; margin-top: 30px; text-align: center; text-shadow: 0 4px 10px rgba(0,0,0,0.5); font-weight: 800; padding: 0 20px; letter-spacing: 1px; }
        #joke-close { width: 200px; margin-top: 40px; padding: 15px; font-size: 16px; background: #ef4444; }
    </style>
</head>
<body>

<div id="joke-overlay">
        <audio id="audio-chaewon" src="chaewon.mp3"></audio>
        <audio id="audio-gay" src="gay.mp3"></audio>
        <img id="joke-gif" src="" alt="S√ºrpriz">
        <div id="joke-text"></div>
        <button id="joke-close" onclick="
            document.getElementById('joke-overlay').style.display='none';
            document.getElementById('audio-chaewon').pause();
            document.getElementById('audio-chaewon').currentTime = 0;
            document.getElementById('audio-gay').pause();
            document.getElementById('audio-gay').currentTime = 0;
        ">KAPAT</button>
</div>
    
    <h1>Lost Ark Astrogem</h1>
    <div id="status-msg">Sistem Y√ºkleniyor...</div>

    <div class="tabs" id="tab-container"></div>

    <div class="container">
        
        <div class="panel">
            <h2>Core Ayarlarƒ±</h2>
            <label>Sun Core:</label>
            <select id="core1">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>
            
            <label>Moon Core:</label>
            <select id="core2">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>

            <label>Star Core:</label>
            <select id="core3">
                <option value="12">Legendary (12 WP)</option>
                <option value="15" selected>Relic (15 WP)</option>
                <option value="17">Ancient (17 WP)</option>
            </select>

            <button id="btn-calculate" class="btn-calc">HESAPLA & KAYDET</button>
            
            <div style="display: flex; gap: 10px;">
                <button id="btn-reset" class="btn-reset">‚Ü∫ SIFIRLA</button>
                <button id="btn-delete-char" class="btn-delete">üóëÔ∏è √áARI Sƒ∞L</button>
            </div>

            <button id="btn-hard-reset" class="btn-hard-reset">‚ö† FABRƒ∞KA AYARLARI (T√ºm Verileri Sil)</button>
        </div>

        <div class="panel">
            <h2>Envanter</h2>
            <div id="gem-inputs"></div>
        </div>

        <div class="panel">
            <h2>Analiz Sonu√ßlarƒ±</h2>
            <div id="result-area">Sonu√ßlar burada g√∂r√ºnecek...</div>
        </div>

    </div>

    <div id="debug-console">Hata Konsolu: Temiz</div>

<py-script>
from js import document, window, localStorage
from itertools import combinations_with_replacement
from collections import Counter
import json
from pyodide.ffi import create_proxy
import traceback

def log_error(e):
    err_div = document.getElementById("debug-console")
    err_div.style.display = "block"
    err_div.innerHTML = f"HATA:<br>{str(e)}<br>{traceback.format_exc()}"


GEM_STATS = {
    # 3 Willpower Grubunun Ta≈ülarƒ± (Kƒ±rmƒ±zƒ±/Sarƒ± Tonlarƒ±)
    "S": {"will": 3, "pts": 5, "color": "#ef4444"},
    "A": {"will": 3, "pts": 4, "color": "#f97316"},
    "B": {"will": 3, "pts": 3, "color": "#f59e0b"},
    "C": {"will": 3, "pts": 2, "color": "#b45309"}, 

    # 4 Willpower Grubunun Ta≈ülarƒ± (Ye≈üil Tonlarƒ±)
    "D": {"will": 4, "pts": 5, "color": "#10b981"},
    "E": {"will": 4, "pts": 4, "color": "#059669"},
    "F": {"will": 4, "pts": 3, "color": "#047857"},
    "G": {"will": 4, "pts": 2, "color": "#064e3b"}, 

    # 5 Willpower Grubunun Ta≈ülarƒ± (Mavi/Mor Tonlarƒ±)
    "H": {"will": 5, "pts": 5, "color": "#3b82f6"},
    "I": {"will": 5, "pts": 4, "color": "#2563eb"},
    "J": {"will": 5, "pts": 3, "color": "#8b5cf6"},
    "K": {"will": 5, "pts": 2, "color": "#6d28d9"}, 

    # 6 Willpower Grubunun Ta≈ülarƒ± (Gri Tonlarƒ±)
    "L": {"will": 6, "pts": 5, "color": "#cbd5e1"},
    "M": {"will": 6, "pts": 4, "color": "#94a3b8"}, 
    "N": {"will": 6, "pts": 3, "color": "#64748b"}, 
    "O": {"will": 6, "pts": 2, "color": "#475569"}, 

    "P": {"will": 7, "pts": 5, "color": "#334155"}, 
    "R": {"will": 7, "pts": 4, "color": "#1e293b"}, 
} 

TARGET_SCORES = {12: 14, 15: 17, 17: 17}
SECONDARY_SCORES = {12: 10, 15: 14, 17: 14}
TERTIARY_SCORES = {12: 10, 15: 10, 17: 10}

current_char = ""
app_data = {}

# --- ≈ûAKA (GIF) TETƒ∞KLEME FONKSƒ∞YONU ---
def check_for_joke(name):
    overlay = document.getElementById("joke-overlay")
    gif = document.getElementById("joke-gif")
    text = document.getElementById("joke-text")

    if name == "Boisy":
        text.innerHTML= "NASI Sƒ∞TE YAPMI≈ûIM AMA √áOK ƒ∞Yƒ∞ Dƒ∞ Mƒ∞"
        gif.src = "chaewon.gif"
        overlay.style.display = "flex"
        document.getElementById("audio-chaewon").play()
                
    elif name == "Aelathea":
        text.innerHTML= "GAY"
        gif.src = "chuu.gif"
        overlay.style.display = "flex"
        document.getElementById("audio-gay").play()
    
    if name == "Abd√ºllrezzak":
        text.innerHTML= "REAPER 1760TAN SONRA A√áILIYOMU≈û"
        gif.src = "reaper.gif"
        overlay.style.display = "flex"
    
    elif name == "Scarleon":
        text.innerHTML= "ESO WARDANCER GAAAAAAANG"
        gif.src = "backattack.gif"
        overlay.style.display = "flex"
        
    elif name == "Tarawah":
        text.innerHTML= "BEN Mƒ∞ DEDƒ∞M REAPER OYNA Dƒ∞YE"
        gif.src = "backattack.gif"
        overlay.style.display = "flex"

# --- Dƒ∞NAMƒ∞K SEKME FONKSƒ∞YONLARI ---
def add_character(event=None):
    try:
        new_name = window.prompt("Yeni karakterin adƒ±nƒ± girin:")
        if new_name and new_name.strip():
            new_name = new_name.strip()
            if new_name in app_data:
                window.alert("Bu isimde bir karakter zaten var!")
                return

            check_for_joke(new_name)
                
            app_data[new_name] = {"inventory": {}, "cores": [0,0,0]}
            global current_char
            current_char = new_name
            save_data()
            render_tabs()
            load_ui_for_char(current_char)
            document.getElementById("result-area").innerHTML = f"--- '{current_char}' olu≈üturuldu ---"
    except Exception as e: log_error(e)

def delete_character(event=None):
    global current_char
    try:
        if window.confirm(f"'{current_char}' isimli karakteri silmek istediƒüinize emin misiniz?"):
            del app_data[current_char]
            if not app_data:
                app_data["Karakter 1"] = {"inventory": {}, "cores": [0,0,0]}
            current_char = list(app_data.keys())[0]
            save_data()
            render_tabs()
            load_ui_for_char(current_char)
            document.getElementById("result-area").innerHTML = f"Karakter silindi.\n--- {current_char} Y√ºklendi ---"
    except Exception as e: log_error(e)

def render_tabs():
    container = document.getElementById("tab-container")
    container.innerHTML = ""
    for name in app_data.keys():
        btn = document.createElement("button")
        btn.innerText = name
        btn.className = "tab-btn"
        if name == current_char: btn.classList.add("active")
        click_proxy = create_proxy(lambda e, n=name: switch_tab(n))
        dbl_click_proxy = create_proxy(lambda e, n=name: rename_tab(n))
        btn.addEventListener("click", click_proxy)
        btn.addEventListener("dblclick", dbl_click_proxy)
        container.appendChild(btn)
        
    add_btn = document.createElement("button")
    add_btn.innerText = "‚ûï Ekle"
    add_btn.className = "tab-btn add-tab-btn"
    add_btn_proxy = create_proxy(add_character)
    add_btn.addEventListener("click", add_btn_proxy)
    container.appendChild(add_btn)

def switch_tab(new_name):
    global current_char
    try:
        save_data()
        current_char = new_name
        render_tabs()
        load_ui_for_char(current_char)
        document.getElementById("result-area").innerHTML = f"--- {current_char} Y√ºklendi ---"
    except Exception as e: log_error(e)

def rename_tab(old_name):
    try:
        new_name = window.prompt(f"Karakter adƒ±nƒ± deƒüi≈ütir ({old_name}):", old_name)
        if new_name and new_name.strip() and new_name != old_name:
            check_for_joke(new_name)
            data = app_data.pop(old_name)
            app_data[new_name] = data
            global current_char
            if current_char == old_name: current_char = new_name
            save_data()
            render_tabs()
    except Exception as e: log_error(e)

# --- VERƒ∞ VE Y√úKLEME ---
def load_ui_for_char(name):
    data = app_data.get(name, {"inventory": {}, "cores": [0,0,0]})
    inv = data.get("inventory", {})
    cores = data.get("cores", [0,0,0])
    for code in GEM_STATS:
        el = document.getElementById(f"gem_{code}")
        if el: el.value = inv.get(code, 0)
    document.getElementById("core1").selectedIndex = cores[0]
    document.getElementById("core2").selectedIndex = cores[1]
    document.getElementById("core3").selectedIndex = cores[2]

def get_ui_data():
    inv = {}
    for code in GEM_STATS:
        el = document.getElementById(f"gem_{code}")
        val = el.value
        inv[code] = int(val) if val else 0
    return {"inventory": inv, "cores": [
        document.getElementById("core1").selectedIndex,
        document.getElementById("core2").selectedIndex,
        document.getElementById("core3").selectedIndex
    ]}

def save_data():
    global app_data
    app_data[current_char] = get_ui_data()
    localStorage.setItem("astrogem_data", json.dumps(app_data))

def load_data():
    global app_data, current_char
    try:
        stored = localStorage.getItem("astrogem_data")
        if stored: 
            app_data = json.loads(stored)
            if not app_data: app_data = {"Karakter 1": {"inventory": {}, "cores": [0,0,0]}}
        else: 
            app_data = {"Karakter 1": {"inventory": {}, "cores": [0,0,0]}}
        current_char = list(app_data.keys())[0]
        render_tabs()
        load_ui_for_char(current_char)
    except Exception as e: log_error(e)

def get_valid_combos(cap, inventory, available_types, t1, t2, t3):
    all_combos = [{"pts": 0, "will": 0, "gems": [], "counts": {}}]
    
    for r in range(1, 5):
        for combo_tuple in combinations_with_replacement(available_types, r):
            w = sum(GEM_STATS[g]["will"] for g in combo_tuple)
            if w > cap: continue
            
            counts = Counter(combo_tuple)
            if all(inventory.get(g, 0) >= c for g, c in counts.items()):
                p = sum(GEM_STATS[g]["pts"] for g in combo_tuple)
                all_combos.append({"pts": p, "will": w, "gems": list(combo_tuple), "counts": dict(counts)})

    primary_combos = [c for c in all_combos if c['pts'] >= t1]
    secondary_combos = [c for c in all_combos if t2 <= c['pts'] < t1]
    tertiary_combos = [c for c in all_combos if t3 <= c['pts'] < t2]
    fail_combos = [c for c in all_combos if c['pts'] < t3]

    primary_greedy = sorted(primary_combos, key=lambda x: (-x["pts"], len(x["gems"]))) 
    primary_humble = sorted(primary_combos, key=lambda x: (x["pts"], len(x["gems"])))  
    
    secondary_greedy = sorted(secondary_combos, key=lambda x: (-x["pts"], len(x["gems"])))
    secondary_cheap = sorted(secondary_combos, key=lambda x: (len(x["gems"]), x["pts"])) 
    
    tertiary_greedy = sorted(tertiary_combos, key=lambda x: (-x["pts"], len(x["gems"])))
    tertiary_cheap = sorted(tertiary_combos, key=lambda x: (len(x["gems"]), x["pts"])) 
    
    fail_greedy = sorted(fail_combos, key=lambda x: (-x["pts"], len(x["gems"])))
    fail_cheap = sorted(fail_combos, key=lambda x: (len(x["gems"]), x["pts"]))

    final_pool = []
    seen = set()

    def add_to_pool(lst, count):
        added = 0
        for item in lst:
            if added >= count: break
            t = tuple(sorted(item['gems']))
            if t not in seen:
                final_pool.append(item)
                seen.add(t)
                added += 1
    
    add_to_pool(primary_humble, 40) 
    add_to_pool(primary_greedy, 40) 
    add_to_pool(secondary_greedy, 30) 
    add_to_pool(secondary_cheap, 20) 
    add_to_pool(tertiary_greedy, 30) 
    add_to_pool(tertiary_cheap, 20) 
    add_to_pool(fail_greedy, 15)
    add_to_pool(fail_cheap, 15)
    
    return final_pool
        
def calculate_click(event):
    try:
        save_data()
        res_div = document.getElementById("result-area")
        res_div.innerHTML = "Hesaplanƒ±yor... L√ºtfen bekleyin."
        
        inventory = {}
        for code in GEM_STATS:
            try:
                val = int(document.getElementById(f"gem_{code}").value)
                if val > 0: inventory[code] = val
            except: pass
        
        core_caps = []
        primaries = []
        secondaries = []
        tertiaries = []
        for i in range(1, 4):
            val = int(document.getElementById(f"core{i}").value)
            core_caps.append(val)
            primaries.append(TARGET_SCORES[val])
            secondaries.append(SECONDARY_SCORES[val])
            tertiaries.append(TERTIARY_SCORES[val])
        
        available_types = list(inventory.keys())
        if not available_types:
            res_div.innerHTML = "Envanter bo≈ü."
            return

        pools = []
        for i in range(3):
            candidates = get_valid_combos(core_caps[i], inventory, available_types, primaries[i], secondaries[i], tertiaries[i])
            pools.append(candidates)

        best_eval = (-1, -1, -1, -1, -1, -1, -1, -1)
        best_assign = []
        found = False

        for c1 in pools[0]:
            inv1 = inventory.copy()
            valid1 = True
            for k, v in c1["counts"].items():
                inv1[k] = inv1.get(k, 0) - v
                if inv1[k] < 0:
                    valid1 = False
                    break
            if not valid1: continue 

            for c2 in pools[1]:
                inv2 = inv1.copy()
                valid2 = True
                for k, v in c2["counts"].items():
                    inv2[k] = inv2.get(k, 0) - v
                    if inv2[k] < 0:
                        valid2 = False
                        break
                if not valid2: continue

                for c3 in pools[2]:
                    valid3 = True
                    for k, v in c3["counts"].items():
                        if inv2.get(k, 0) < v:
                            valid3 = False
                            break
                    if not valid3: continue
                    
                    current_score = c1["pts"] + c2["pts"] + c3["pts"]
                    
                    tier_score = 0
                    if c1["pts"] >= primaries[0]: tier_score += 3
                    elif c1["pts"] >= secondaries[0]: tier_score += 2
                    elif c1["pts"] >= tertiaries[0]: tier_score += 1
                    
                    if c2["pts"] >= primaries[1]: tier_score += 3
                    elif c2["pts"] >= secondaries[1]: tier_score += 2
                    elif c2["pts"] >= tertiaries[1]: tier_score += 1
                    
                    if c3["pts"] >= primaries[2]: tier_score += 3
                    elif c3["pts"] >= secondaries[2]: tier_score += 2
                    elif c3["pts"] >= tertiaries[2]: tier_score += 1
                    
                    current_max_single = max(c1["pts"], c2["pts"], c3["pts"])

                    # YENƒ∞: ASIL HEDEF (PRIMARY) SAYACI (MUTLAK 1. √ñNCELƒ∞K)
                    primary_success_count = 0
                    if c1["pts"] >= primaries[0]: primary_success_count += 1
                    if c2["pts"] >= primaries[1]: primary_success_count += 1
                    if c3["pts"] >= primaries[2]: primary_success_count += 1

                    # √ñZEL √ñNCELƒ∞K KURALLARI
                    sun_moon_14 = 1 if (c1["pts"] >= 14 and c2["pts"] >= 14) else 0
                    sun_17 = 1 if c1["pts"] >= 17 else 0
                    moon_17 = 1 if c2["pts"] >= 17 else 0
                    star_17 = 1 if c3["pts"] >= 17 else 0
                    
                    # Kar≈üƒ±la≈ütƒ±rma Paketi (TUPLE)
                    current_eval = (primary_success_count, tier_score, sun_moon_14, sun_17, moon_17, star_17, current_score, current_max_single)

                    if current_eval > best_eval:
                        best_eval = current_eval
                        best_assign = [c1, c2, c3]
                        found = True
        
        if not found:
            best_score = 0
            best_assign = []
            curr_inv = inventory.copy()
            for i in range(3):
                cands = get_valid_combos(core_caps[i], curr_inv, list(curr_inv.keys()), primaries[i], secondaries[i], tertiaries[i])
                best = cands[0] if cands else {"pts":0, "gems":[]}
                if best["gems"]:
                    for g in best["gems"]: 
                        if curr_inv.get(g,0)>0: curr_inv[g]-=1
                best_assign.append(best)
                best_score += best["pts"]
        else:
            best_score = best_eval[6] # Tuple g√ºncellendiƒüi i√ßin index kaydƒ±

        output = f"=== {current_char} SONU√áLARI ===\n"
        output += f"TOPLAM PUAN: {best_score}\n"
        
        all_gems = list(GEM_STATS.keys())
        core_names = ["Sun Core", "Moon Core", "Star Core"] 
        
        remaining_inv = inventory.copy()
        for res in best_assign:
            for g in res["gems"]:
                if remaining_inv.get(g, 0) > 0:
                    remaining_inv[g] -= 1
        
        for i, res in enumerate(best_assign):
            cap = core_caps[i]
            p_target = primaries[i]
            s_target = secondaries[i]
            t_target = tertiaries[i]
            pts = res["pts"]
            
            if pts >= p_target:
                status = "‚úÖ"
            elif pts >= s_target:
                status = f"‚ö†Ô∏è (Ara Hedef {s_target}P)"
            elif pts >= t_target:
                status = f"‚ö†Ô∏è (Ara Hedef {t_target}P)"
            else:
                status = "‚ùå"
            
            output += f"\n{core_names[i]} ({cap}W): {pts}/{p_target} {status}\n"
            gem_str = "+".join(res['gems']) if res['gems'] else 'BO≈û'
            output += f"Tak: {gem_str}\n"
            
            if pts < p_target:
                output += "[√ñNERƒ∞LER]\n"
                sugs = []
                for r in range(1, 5):
                    for combo in combinations_with_replacement(all_gems, r):
                        w = sum(GEM_STATS[g]["will"] for g in combo)
                        p = sum(GEM_STATS[g]["pts"] for g in combo)
                        
                        if w <= cap and p >= p_target:
                            need = Counter(combo)
                            have_in_core = Counter(res["gems"])
                            leftovers = Counter(remaining_inv)
                            
                            total_have = have_in_core + leftovers
                            truly_missing = list((need - total_have).elements())
                            
                            cost = len(truly_missing)
                            will_diff = cap - w  
                            pts_diff = p - p_target 
                            
                            sugs.append({
                                "combo": combo, 
                                "miss": truly_missing, 
                                "cost": cost, 
                                "will_diff": will_diff, 
                                "pts_diff": pts_diff, 
                                "will": w
                            })
                
                if sugs:
                    sugs.sort(key=lambda x: (x["cost"], x["will_diff"], x["pts_diff"]))
                    
                    cnt = 0
                    shown = []
                    for s in sugs:
                        cstr = str(sorted(s["combo"]))
                        if cstr in shown: continue
                        shown.append(cstr)
                        cnt += 1
                        
                        miss_str = ",".join(s['miss']) if s['miss'] else "Envanterde var (Bo≈üta)"
                        output += f" 1. Bul: {miss_str}\n"
                        output += f"    Hedef: {'+'.join(s['combo'])} ({s['will']}W)\n"
                        if cnt >= 1: break
            output += "-"*30 + "\n"
        
        res_div.innerHTML = output

    except Exception as e: log_error(e)
                            
def reset_click(event):
    try:
        for code in GEM_STATS:
            el = document.getElementById(f"gem_{code}")
            if el: el.value = 0
        document.getElementById("result-area").innerHTML = "Sayƒ±lar Sƒ±fƒ±rlandƒ±."
        save_data()
    except Exception as e: log_error(e)

def hard_reset_click(event):
    if window.confirm("Dƒ∞KKAT: T√ºm karakterler ve veriler silinecek. Emin misiniz?"):
        localStorage.removeItem("astrogem_data")
        window.location.reload()

# BA≈ûLANGI√á
try:
    gem_container = document.getElementById("gem-inputs")
    gem_container.innerHTML = ""
    for code, stats in GEM_STATS.items():
        div = document.createElement("div")
        div.className = "gem-row"
        div.innerHTML = f'''
            <div style="display:flex; align-items:center;">
                <div class="gem-icon" style="background-color: {stats['color']}\">{code}</div>
                <span>{stats['will']}W / {stats['pts']}P</span>
            </div>
            <input type=\"number\" id=\"gem_{code}\" min=\"0\" value=\"0\">
        '''
        gem_container.appendChild(div)

    load_data()
    calc_proxy = create_proxy(calculate_click)
    reset_proxy = create_proxy(reset_click)
    delete_proxy = create_proxy(delete_character)
    hard_reset_proxy = create_proxy(hard_reset_click)
    
    document.getElementById("btn-calculate").addEventListener("click", calc_proxy)
    document.getElementById("btn-reset").addEventListener("click", reset_proxy)
    document.getElementById("btn-delete-char").addEventListener("click", delete_proxy)
    document.getElementById("btn-hard-reset").addEventListener("click", hard_reset_proxy)
    
    document.getElementById("status-msg").innerHTML = "Sistem Hazƒ±r! üéâ"
    document.getElementById("status-msg").style.color = "#10b981"
except Exception as e: log_error(e)

</py-script>
</body>
</html>
